---
title: "Target Product Profile"
author: "Suzanne Dufault"
date: "`r Sys.Date()`"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      warning = FALSE,
                      message = FALSE,
                      fig.path = "../graphs/")

library(tidyverse)
library(here)
library(latex2exp)
source(here("lib","ucsf-color-palette.R"))

load("~/OneDrive - University of California, San Francisco/ucsf-research/phase2b-simstudy/data/cleaned-results/2022-02-25_mcmc-mods-even-30.RData")
load("~/OneDrive - University of California, San Francisco/ucsf-research/phase2b-simstudy/data/cleaned-results/2022-02-25_mcmc-mods-even-40.RData")
load("~/OneDrive - University of California, San Francisco/ucsf-research/phase2b-simstudy/data/cleaned-results/2022-02-25_mcmc-mods-even-20.RData")
```

# Target Product Profile Walk-Through {.tabset}

Using notation from Pulkstenis et al. The target product profile (TPP) requires the specification of four primary quantities of interest:

+ $\theta_{LRV}$: **lower reference value**, the minimal level of acceptable efficacy
  + $\tau_{LRV}$: **false GO rate**, the maximum allowable risk that you advance a regimen that does not reach the minimal level of acceptable efficacy
+ $\theta_{TV}$: **target value**, the level of efficacy corresponding to solid competitiveness
  + $\tau_{TV}$: **false NO-GO rate**, the maximum allowable risk that you stop a regimen that does have solid competitiveness
  
```{r}
theta_lrv <- 0 # lower reference value
theta_tv <- 20 # target value
tau_tv <- 0.025 # false no-go risk
tau_lrv <- 0.025 # false go risk
```
  
## Single Example

In a single study, we can visualize this in a handful of ways. Below is an example from the simulated data comparing 4 novel regimens against a control with 30 participants assigned per regimen. **Panel A** shows the posterior distributions for the estimated % increase in log10(TTP) slope of each regimen relative to the control regimen. **Panel B** shows the Bayesian credible intervals for each regimen. These are used for decision-making.

In this example:

+ $\theta_{LRV} =$ 0% 
+ $\theta_{TV}=$ 20%
+ $\tau_{LRV} = \tau_{TV} = 2.5$%

```{r tpp-posterior-distribution-example, fig.width = 12, fig.height = 5, fig.cap = "Recreation of Figure 1 from Pulkstenis et al."}
  # Convert to % relative to control
p1 <- mcmc_mods_even_30[[1]] %>% 
  mutate(`Regimen 1` = ((arm2/arm1) - 1)*100,
         `Regimen 2` = ((arm3/arm1) - 1)*100,
         `Regimen 3` = ((arm4/arm1) - 1)*100,
         `Regimen 4` = ((arm5/arm1) - 1)*100) %>% 
  dplyr::select(`Regimen 1`:`Regimen 4`) %>% 
  pivot_longer(cols = 1:4,
               names_to = "Regimen",
               values_to = "Slope, %") %>% 
  ggplot(aes(x = `Slope, %`, fill = Regimen)) + 
  geom_density(alpha = 0.3,
               col = "white") + 
  ggpubr::theme_pubr() +
  geom_segment(aes(x = theta_lrv, xend = theta_lrv, y = 0, yend = 0.05), lty = 2) + 
  geom_segment(aes(x = theta_tv, xend = theta_tv, y = 0, yend = 0.05), lty = 2) + 
  annotate(geom = "text", x = theta_lrv, y = 0.051, label = TeX("$\\theta_{LRV}$"), vjust = 0) +
  annotate(geom = "text", x = theta_tv, y = 0.051, label = TeX("$\\theta_{TV}$"), vjust = 0) +
  annotate(geom = "text", x = -18, y = -0.001, label = "Minimal Case", hjust = 0) +
  annotate(geom = "text", x = 10, y = -0.001, label = "Lower Case") +
  annotate(geom = "text", x = 30, y = -0.001, label = "Target Case") + 
  scale_x_continuous(breaks = seq(-30,100,by = 10),
                     labels = seq(-30,100,by = 10)) +
  ylab("Posterior probability distribution") +
  scale_fill_manual(values = ucsf_col_pal) + 
  theme(legend.position = "bottom")

  # Convert to % relative to control
p2 <- mcmc_mods_even_30[[1]] %>% 
  mutate(`Regimen 1` = ((arm2/arm1) - 1)*100,
         `Regimen 2` = ((arm3/arm1) - 1)*100,
         `Regimen 3` = ((arm4/arm1) - 1)*100,
         `Regimen 4` = ((arm5/arm1) - 1)*100) %>% 
  dplyr::select(`Regimen 1`:`Regimen 4`) %>% 
  pivot_longer(cols = 1:4,
               names_to = "Regimen",
               values_to = "Slope, %") %>% 
  group_by(Regimen) %>% 
  summarise(CI.025 = quantile(`Slope, %`, probs = tau_lrv),
            CI.975 = quantile(`Slope, %`, probs = 1-tau_tv)) %>% 
  mutate(Decision = case_when(CI.975 < theta_tv ~ "NO-GO", # If it doesn't have hope of reaching target value, it's stopped
                              ((CI.025 > theta_lrv) & (CI.975 > theta_tv)) ~ "GO", # if the CI includes TV and is entirely above the LRV, then it goes
                              TRUE ~ "Continue")) %>% 
  mutate(Decision = factor(Decision, levels = c("NO-GO", "Continue", "GO"))) %>% 
  ungroup() %>% 
  mutate(nr = row_number()) %>% 
  ggplot() + 
  geom_segment(aes(y = nr, yend = nr, 
                   x = CI.025, xend = CI.975, 
                   col = Decision),
               lwd = 1) + 
  ggpubr::theme_pubr() + 
  geom_segment(aes(x = 0, xend = 0, y = 0, yend = 4.45), 
               lty = 2) + 
  scale_color_manual(values = c(ucsf_col_pal[4], ucsf_col_pal[8], "red"),
                     breaks = c("GO", "Continue", "NO-GO"),
                     labels = c("GO", "Continue", "NO-GO"),
                     drop = FALSE) +
  geom_segment(aes(x = 20, xend = 20, y = 0, yend = 4.45), 
               lty = 2) + 
  annotate(geom = "text", x = 0, y = -0.2, label = TeX("$\\theta_{LRV}$"), vjust = 0) +
  annotate(geom = "text", x = 20, y = -0.2, label = TeX("$\\theta_{TV}$"), vjust = 0) +
  scale_x_continuous("95% Credible Interval on Relative Slope, %", 
                     breaks = seq(0,100,by = 10),
                     labels = seq(0,100,by = 10)) +
  scale_y_continuous(breaks = 1:4,
                     labels = paste0("Regimen ", 1:4)) +
  theme(axis.title.y = element_blank(),
        legend.position = "bottom")

ggpubr::ggarrange(p1, p2, nrow = 1, widths = c(3,2))
```

## Across Simulations

```{r barplot_decision-probabilities, fig.width = 12, fig.height = 4}
decisions <- mcmc_mods_even_30 %>% 
  map_dfr(
    # Convert to % relative to control
    ~mutate(.x, `Regimen 1` = ((arm2/arm1) - 1)*100,
            `Regimen 2` = ((arm3/arm1) - 1)*100,
            `Regimen 3` = ((arm4/arm1) - 1)*100,
            `Regimen 4` = ((arm5/arm1) - 1)*100) %>% 
      dplyr::select(`Regimen 1`:`Regimen 4`) %>% 
      pivot_longer(cols = 1:4,
                   names_to = "Regimen",
                   values_to = "Slope, %") %>% 
      group_by(Regimen) %>% 
      summarise(CI.025 = quantile(`Slope, %`, probs = tau_lrv),
                CI.975 = quantile(`Slope, %`, probs = 1-tau_tv)) %>% 
      mutate(Decision = case_when(CI.975 < theta_tv ~ "NO-GO", # If it doesn't have hope of reaching target value, it's stopped
                                  ((CI.025 > theta_lrv) & (CI.975 > theta_tv)) ~ "GO", # if the CI includes TV and is entirely above the LRV, then it goes
                                  TRUE ~ "Continue")),
    .id = "sim")

decisions_40 <- mcmc_mods_even_40 %>% 
  map_dfr(
    # Convert to % relative to control
    ~mutate(.x, `Regimen 1` = ((arm2/arm1) - 1)*100,
            `Regimen 2` = ((arm3/arm1) - 1)*100,
            `Regimen 3` = ((arm4/arm1) - 1)*100,
            `Regimen 4` = ((arm5/arm1) - 1)*100) %>% 
      dplyr::select(`Regimen 1`:`Regimen 4`) %>% 
      pivot_longer(cols = 1:4,
                   names_to = "Regimen",
                   values_to = "Slope, %") %>% 
      group_by(Regimen) %>% 
      summarise(CI.025 = quantile(`Slope, %`, probs = tau_lrv),
                CI.975 = quantile(`Slope, %`, probs = 1-tau_tv)) %>% 
      mutate(Decision = case_when(CI.975 < theta_tv ~ "NO-GO", # If it doesn't have hope of reaching target value, it's stopped
                                  ((CI.025 > theta_lrv) & (CI.975 > theta_tv)) ~ "GO", # if the CI includes TV and is entirely above the LRV, then it goes
                                  TRUE ~ "Continue")),
    .id = "sim")

decisions_20 <- mcmc_mods_even_20 %>% 
  map_dfr(
    # Convert to % relative to control
    ~mutate(.x, `Regimen 1` = ((arm2/arm1) - 1)*100,
            `Regimen 2` = ((arm3/arm1) - 1)*100,
            `Regimen 3` = ((arm4/arm1) - 1)*100,
            `Regimen 4` = ((arm5/arm1) - 1)*100) %>% 
      dplyr::select(`Regimen 1`:`Regimen 4`) %>% 
      pivot_longer(cols = 1:4,
                   names_to = "Regimen",
                   values_to = "Slope, %") %>% 
      group_by(Regimen) %>% 
      summarise(CI.025 = quantile(`Slope, %`, probs = tau_lrv),
                CI.975 = quantile(`Slope, %`, probs = 1-tau_tv)) %>% 
      mutate(Decision = case_when(CI.975 < theta_tv ~ "NO-GO", # If it doesn't have hope of reaching target value, it's stopped
                                  ((CI.025 > theta_lrv) & (CI.975 > theta_tv)) ~ "GO", # if the CI includes TV and is entirely above the LRV, then it goes
                                  TRUE ~ "Continue")),
    .id = "sim")

p3 <- decisions %>% 
  group_by(Regimen, Decision) %>% 
  summarise(n = n_distinct(sim)) %>% 
  group_by(Regimen) %>% 
  mutate(Probability = n/sum(n),
         Decision = factor(Decision, levels = c("NO-GO", "Continue", "GO"))) %>% 
  ggplot(aes(x = Regimen, y = Probability, fill = Decision)) + 
  scale_fill_manual(values = c("red", ucsf_col_pal[8], ucsf_col_pal[4]),
                    breaks = c("NO-GO", "Continue", "GO"),
                    labels = c("NO-GO", "Continue", "GO")) +
  geom_bar(stat = "identity",
           alpha = 0.9) + 
  scale_y_continuous("Decision Probability",
                     breaks = seq(0,1,by = 0.1),
                     labels = seq(0,1,by = 0.1)) +
  scale_x_discrete("Relative Slope, %",
                   labels = c("10%", "20%", "30%", "40%")) + 
  ggpubr::theme_pubr() + 
  ggtitle(TeX("Results from 1000 simulations, $n_k = 30$"), subtitle = TeX("$\\theta_{LRV} = 0%$, $\\theta_{TV} = 20%$, $\\tau_{TV} = \\tau_{LRV} = 0.025$")) +
  theme(legend.position = "bottom")

p4 <- decisions_40 %>% 
  group_by(Regimen, Decision) %>% 
  summarise(n = n_distinct(sim)) %>% 
  group_by(Regimen) %>% 
  mutate(Probability = n/sum(n),
         Decision = factor(Decision, levels = c("NO-GO", "Continue", "GO"))) %>% 
  ggplot(aes(x = Regimen, y = Probability, fill = Decision)) + 
  scale_fill_manual(values = c("red", ucsf_col_pal[8], ucsf_col_pal[4]),
                    breaks = c("NO-GO", "Continue", "GO"),
                    labels = c("NO-GO", "Continue", "GO")) +
  geom_bar(stat = "identity",
           alpha = 0.9) + 
  scale_y_continuous("Decision Probability",
                     breaks = seq(0,1,by = 0.1),
                     labels = seq(0,1,by = 0.1)) +
  scale_x_discrete("Relative Slope, %",
                   labels = c("10%", "20%", "30%", "40%")) + 
  ggpubr::theme_pubr() + 
  ggtitle(TeX("Results from 1000 simulations, $n_k = 40$"), subtitle = TeX("$\\theta_{LRV} = 0%$, $\\theta_{TV} = 20%$, $\\tau_{TV} = \\tau_{LRV} = 0.025$")) +
  theme(legend.position = "bottom")


p5 <- decisions_20 %>% 
  group_by(Regimen, Decision) %>% 
  summarise(n = n_distinct(sim)) %>% 
  group_by(Regimen) %>% 
  mutate(Probability = n/sum(n),
         Decision = factor(Decision, levels = c("NO-GO", "Continue", "GO"))) %>% 
  ggplot(aes(x = Regimen, y = Probability, fill = Decision)) + 
  scale_fill_manual(values = c("red", ucsf_col_pal[8], ucsf_col_pal[4]),
                    breaks = c("NO-GO", "Continue", "GO"),
                    labels = c("NO-GO", "Continue", "GO")) +
  geom_bar(stat = "identity",
           alpha = 0.9) + 
  scale_y_continuous("Decision Probability",
                     breaks = seq(0,1,by = 0.1),
                     labels = seq(0,1,by = 0.1)) +
  scale_x_discrete("Relative Slope, %",
                   labels = c("10%", "20%", "30%", "40%")) + 
  ggpubr::theme_pubr() + 
  ggtitle(TeX("Results from 1000 simulations, $n_k = 20$"), subtitle = TeX("$\\theta_{LRV} = 0%$, $\\theta_{TV} = 20%$, $\\tau_{TV} = \\tau_{LRV} = 0.025$")) +
  theme(legend.position = "bottom")

ggpubr::ggarrange(p5, p3, p4, nrow = 1, common.legend = TRUE)
```

```{r}
load("~/OneDrive - University of California, San Francisco/ucsf-research/phase2b-simstudy/data/cleaned-results/2022-02-25_mcmc-mods-highlow-20.RData")
load("~/OneDrive - University of California, San Francisco/ucsf-research/phase2b-simstudy/data/cleaned-results/2022-02-25_mcmc-mods-highlow-30.RData")
load("~/OneDrive - University of California, San Francisco/ucsf-research/phase2b-simstudy/data/cleaned-results/2022-02-25_mcmc-mods-highlow-40.RData")
```

```{r barplot_decision-probabilities_highlow, fig.width = 12, fig.height = 4}
decisions_hl <- mcmc_mods_highlow_30 %>% 
  map_dfr(
    # Convert to % relative to control
    ~mutate(.x, `Regimen 1` = ((arm2/arm1) - 1)*100,
            `Regimen 2` = ((arm3/arm1) - 1)*100,
            `Regimen 3` = ((arm4/arm1) - 1)*100,
            `Regimen 4` = ((arm5/arm1) - 1)*100) %>% 
      dplyr::select(`Regimen 1`:`Regimen 4`) %>% 
      pivot_longer(cols = 1:4,
                   names_to = "Regimen",
                   values_to = "Slope, %") %>% 
      group_by(Regimen) %>% 
      summarise(CI.025 = quantile(`Slope, %`, probs = tau_lrv),
                CI.975 = quantile(`Slope, %`, probs = 1-tau_tv)) %>% 
      mutate(Decision = case_when(CI.975 < theta_tv ~ "NO-GO", # If it doesn't have hope of reaching target value, it's stopped
                                  ((CI.025 > theta_lrv) & (CI.975 > theta_tv)) ~ "GO", # if the CI includes TV and is entirely above the LRV, then it goes
                                  TRUE ~ "Continue")),
    .id = "sim")

decisions_40_hl <- mcmc_mods_highlow_40 %>% 
  map_dfr(
    # Convert to % relative to control
    ~mutate(.x, `Regimen 1` = ((arm2/arm1) - 1)*100,
            `Regimen 2` = ((arm3/arm1) - 1)*100,
            `Regimen 3` = ((arm4/arm1) - 1)*100,
            `Regimen 4` = ((arm5/arm1) - 1)*100) %>% 
      dplyr::select(`Regimen 1`:`Regimen 4`) %>% 
      pivot_longer(cols = 1:4,
                   names_to = "Regimen",
                   values_to = "Slope, %") %>% 
      group_by(Regimen) %>% 
      summarise(CI.025 = quantile(`Slope, %`, probs = tau_lrv),
                CI.975 = quantile(`Slope, %`, probs = 1-tau_tv)) %>% 
      mutate(Decision = case_when(CI.975 < theta_tv ~ "NO-GO", # If it doesn't have hope of reaching target value, it's stopped
                                  ((CI.025 > theta_lrv) & (CI.975 > theta_tv)) ~ "GO", # if the CI includes TV and is entirely above the LRV, then it goes
                                  TRUE ~ "Continue")),
    .id = "sim")

decisions_20_hl <- mcmc_mods_highlow_20 %>% 
  map_dfr(
    # Convert to % relative to control
    ~mutate(.x, `Regimen 1` = ((arm2/arm1) - 1)*100,
            `Regimen 2` = ((arm3/arm1) - 1)*100,
            `Regimen 3` = ((arm4/arm1) - 1)*100,
            `Regimen 4` = ((arm5/arm1) - 1)*100) %>% 
      dplyr::select(`Regimen 1`:`Regimen 4`) %>% 
      pivot_longer(cols = 1:4,
                   names_to = "Regimen",
                   values_to = "Slope, %") %>% 
      group_by(Regimen) %>% 
      summarise(CI.025 = quantile(`Slope, %`, probs = tau_lrv),
                CI.975 = quantile(`Slope, %`, probs = 1-tau_tv)) %>% 
      mutate(Decision = case_when(CI.975 < theta_tv ~ "NO-GO", # If it doesn't have hope of reaching target value, it's stopped
                                  ((CI.025 > theta_lrv) & (CI.975 > theta_tv)) ~ "GO", # if the CI includes TV and is entirely above the LRV, then it goes
                                  TRUE ~ "Continue")),
    .id = "sim")

p3 <- decisions_hl %>% 
  group_by(Regimen, Decision) %>% 
  summarise(n = n_distinct(sim)) %>% 
  group_by(Regimen) %>% 
  mutate(Probability = n/sum(n),
         Decision = factor(Decision, levels = c("NO-GO", "Continue", "GO"))) %>% 
  ggplot(aes(x = Regimen, y = Probability, fill = Decision)) + 
  scale_fill_manual(values = c("red", ucsf_col_pal[8], ucsf_col_pal[4]),
                    breaks = c("NO-GO", "Continue", "GO"),
                    labels = c("NO-GO", "Continue", "GO")) +
  geom_bar(stat = "identity",
           alpha = 0.9) + 
  scale_y_continuous("Decision Probability",
                     breaks = seq(0,1,by = 0.1),
                     labels = seq(0,1,by = 0.1)) +
  scale_x_discrete("Relative Slope, %",
                   labels = c("-10%", "10%", "35%", "40%")) + 
  ggpubr::theme_pubr() + 
  ggtitle(TeX("Results from 1000 simulations, $n_k = 30$"), subtitle = TeX("$\\theta_{LRV} = 0%$, $\\theta_{TV} = 20%$, $\\tau_{TV} = \\tau_{LRV} = 0.025$")) +
  theme(legend.position = "bottom")

p4 <- decisions_40_hl %>% 
  group_by(Regimen, Decision) %>% 
  summarise(n = n_distinct(sim)) %>% 
  group_by(Regimen) %>% 
  mutate(Probability = n/sum(n),
         Decision = factor(Decision, levels = c("NO-GO", "Continue", "GO"))) %>% 
  ggplot(aes(x = Regimen, y = Probability, fill = Decision)) + 
  scale_fill_manual(values = c("red", ucsf_col_pal[8], ucsf_col_pal[4]),
                    breaks = c("NO-GO", "Continue", "GO"),
                    labels = c("NO-GO", "Continue", "GO")) +
  geom_bar(stat = "identity",
           alpha = 0.9) + 
  scale_y_continuous("Decision Probability",
                     breaks = seq(0,1,by = 0.1),
                     labels = seq(0,1,by = 0.1)) +
  scale_x_discrete("Relative Slope, %",
                   labels = c("-10%", "10%", "35%", "40%")) + 
  ggpubr::theme_pubr() + 
  ggtitle(TeX("Results from 1000 simulations, $n_k = 40$"), subtitle = TeX("$\\theta_{LRV} = 0%$, $\\theta_{TV} = 20%$, $\\tau_{TV} = \\tau_{LRV} = 0.025$")) +
  theme(legend.position = "bottom")


p5 <- decisions_20_hl %>% 
  group_by(Regimen, Decision) %>% 
  summarise(n = n_distinct(sim)) %>% 
  group_by(Regimen) %>% 
  mutate(Probability = n/sum(n),
         Decision = factor(Decision, levels = c("NO-GO", "Continue", "GO"))) %>% 
  ggplot(aes(x = Regimen, y = Probability, fill = Decision)) + 
  scale_fill_manual(values = c("red", ucsf_col_pal[8], ucsf_col_pal[4]),
                    breaks = c("NO-GO", "Continue", "GO"),
                    labels = c("NO-GO", "Continue", "GO")) +
  geom_bar(stat = "identity",
           alpha = 0.9) + 
  scale_y_continuous("Decision Probability",
                     breaks = seq(0,1,by = 0.1),
                     labels = seq(0,1,by = 0.1)) +
  scale_x_discrete("Relative Slope, %",
                   labels = c("-10%", "10%", "35%", "40%")) + 
  ggpubr::theme_pubr() + 
  ggtitle(TeX("Results from 1000 simulations, $n_k = 20$"), subtitle = TeX("$\\theta_{LRV} = 0%$, $\\theta_{TV} = 20%$, $\\tau_{TV} = \\tau_{LRV} = 0.025$")) +
  theme(legend.position = "bottom")

ggpubr::ggarrange(p5, p3, p4, nrow = 1, common.legend = TRUE)
```

```{r}
p20 <- decisions_20_hl %>% 
  filter(Regimen == "Regimen 1") %>% 
  mutate(Regimen = "Regimen 0") %>% 
  bind_rows(decisions_20) %>% 
  group_by(Regimen, Decision) %>% 
  summarise(n = n_distinct(sim)) %>% 
  group_by(Regimen) %>% 
  mutate(Probability = n/sum(n),
         Decision = factor(Decision, levels = c("NO-GO", "Continue", "GO"))) %>% 
  ggplot(aes(x = Regimen, y = Probability, fill = Decision)) + 
  scale_fill_manual(values = c("red", ucsf_col_pal[8], ucsf_col_pal[4]),
                    breaks = c("NO-GO", "Continue", "GO"),
                    labels = c("NO-GO", "Continue", "GO")) +
  geom_bar(stat = "identity",
           alpha = 0.9) + 
  scale_y_continuous("Decision Probability",
                     breaks = seq(0,1,by = 0.1),
                     labels = seq(0,1,by = 0.1)) +
  scale_x_discrete("Relative Slope, %",
                   labels = c("-10%", "10%", "20%","30%","40%")) + 
  ggpubr::theme_pubr() + 
  ggtitle(TeX("Results from 1000 simulations, $n_k = 20$"), subtitle = TeX("$\\theta_{LRV} = 0%$, $\\theta_{TV} = 20%$, $\\tau_{TV} = \\tau_{LRV} = 0.025$")) +
  theme(legend.position = "bottom")

p30 <- decisions_hl %>% 
  filter(Regimen == "Regimen 1") %>% 
  mutate(Regimen = "Regimen 0") %>% 
  bind_rows(decisions) %>% 
  group_by(Regimen, Decision) %>% 
  summarise(n = n_distinct(sim)) %>% 
  group_by(Regimen) %>% 
  mutate(Probability = n/sum(n),
         Decision = factor(Decision, levels = c("NO-GO", "Continue", "GO"))) %>% 
  ggplot(aes(x = Regimen, y = Probability, fill = Decision)) + 
  scale_fill_manual(values = c("red", ucsf_col_pal[8], ucsf_col_pal[4]),
                    breaks = c("NO-GO", "Continue", "GO"),
                    labels = c("NO-GO", "Continue", "GO")) +
  geom_bar(stat = "identity",
           alpha = 0.9) + 
  scale_y_continuous("Decision Probability",
                     breaks = seq(0,1,by = 0.1),
                     labels = seq(0,1,by = 0.1)) +
  scale_x_discrete("Relative Slope, %",
                   labels = c("-10%", "10%", "20%","30%","40%")) + 
  ggpubr::theme_pubr() + 
  ggtitle(TeX("Results from 1000 simulations, $n_k = 30$"), subtitle = TeX("$\\theta_{LRV} = 0%$, $\\theta_{TV} = 20%$, $\\tau_{TV} = \\tau_{LRV} = 0.025$")) +
  theme(legend.position = "bottom")

p40 <- decisions_40_hl %>% 
  filter(Regimen == "Regimen 1") %>% 
  mutate(Regimen = "Regimen 0") %>% 
  bind_rows(decisions_40) %>% 
  group_by(Regimen, Decision) %>% 
  summarise(n = n_distinct(sim)) %>% 
  group_by(Regimen) %>% 
  mutate(Probability = n/sum(n),
         Decision = factor(Decision, levels = c("NO-GO", "Continue", "GO"))) %>% 
  ggplot(aes(x = Regimen, y = Probability, fill = Decision)) + 
  scale_fill_manual(values = c("red", ucsf_col_pal[8], ucsf_col_pal[4]),
                    breaks = c("NO-GO", "Continue", "GO"),
                    labels = c("NO-GO", "Continue", "GO")) +
  geom_bar(stat = "identity",
           alpha = 0.9) + 
  scale_y_continuous("Decision Probability",
                     breaks = seq(0,1,by = 0.1),
                     labels = seq(0,1,by = 0.1)) +
  scale_x_discrete("Relative Slope, %",
                   labels = c("-10%", "10%", "20%","30%","40%")) + 
  ggpubr::theme_pubr() + 
  ggtitle(TeX("Results from 1000 simulations, $n_k = 40$"), subtitle = TeX("$\\theta_{LRV} = 0%$, $\\theta_{TV} = 20%$, $\\tau_{TV} = \\tau_{LRV} = 0.025$")) +
  theme(legend.position = "bottom")

# ggpubr::ggarrange(p20, p30, p40, ncol = 1)
p20
p30
p40
```

```{r barplot_sample-size-decisions, fig.width = 8, fig.height = 5}
d30 <- decisions_hl %>% 
  filter(Regimen == "Regimen 1") %>% 
  mutate(Regimen = "Regimen 0") %>% 
  bind_rows(decisions) %>% 
  mutate(nk = 30)

d20 <- decisions_20_hl %>% 
  filter(Regimen == "Regimen 1") %>% 
  mutate(Regimen = "Regimen 0") %>% 
  bind_rows(decisions_20) %>% 
  mutate(nk = 20)

d40 <- decisions_40_hl %>% 
  filter(Regimen == "Regimen 1") %>% 
  mutate(Regimen = "Regimen 0") %>% 
  bind_rows(decisions_40) %>% 
  mutate(nk = 40)

bind_rows(d20, d30, d40) %>% 
  group_by(Regimen, Decision, nk) %>% 
  summarise(n = n_distinct(sim)) %>% 
  group_by(Regimen, nk) %>% 
  mutate(Probability = n/sum(n),
         Decision = factor(Decision, levels = c("NO-GO", "Continue", "GO"))) %>% 
  mutate(Regimen.slope = case_when(Regimen == "Regimen 0" ~ "-10%", 
                                   Regimen == "Regimen 1" ~ "10%", 
                                   Regimen == "Regimen 2" ~ "20%",
                                   Regimen == "Regimen 3" ~ "30%",
                                   Regimen == "Regimen 4" ~ "40%")) %>% 
  ggplot(aes(x = nk, y = Probability, fill = Decision)) + 
  scale_fill_manual(values = c("red", ucsf_col_pal[8], ucsf_col_pal[4]),
                    breaks = c("NO-GO", "Continue", "GO"),
                    labels = c("NO-GO", "Continue", "GO")) +
  facet_wrap(~Regimen.slope, nrow = 1) +
  geom_bar(stat = "identity",
           alpha = 0.9) + 
  scale_y_continuous("Decision Probability",
                     breaks = seq(0,1,by = 0.1),
                     labels = seq(0,1,by = 0.1)) +
  xlab(TeX("$n_k")) + 
  ggpubr::theme_pubr() + 
  ggtitle(TeX("Results from 1000 simulations"), subtitle = TeX("$\\theta_{LRV} = 0%$, $\\theta_{TV} = 20%$, $\\tau_{TV} = \\tau_{LRV} = 0.025$")) +
  theme(legend.position = "bottom")
```

```{r}
library(kableExtra)

bind_rows(d20, d30, d40) %>% 
  group_by(Regimen, Decision, nk) %>% 
  summarise(n = n_distinct(sim)) %>% 
  group_by(Regimen, nk) %>% 
  mutate(Probability = n/sum(n),
         Decision = factor(Decision, levels = c("NO-GO", "Continue", "GO"))) %>% 
  mutate(Regimen.slope = case_when(Regimen == "Regimen 0" ~ "-10%", 
                                   Regimen == "Regimen 1" ~ "10%", 
                                   Regimen == "Regimen 2" ~ "20%",
                                   Regimen == "Regimen 3" ~ "30%",
                                   Regimen == "Regimen 4" ~ "40%")) %>% 
  ungroup() %>% 
  dplyr::select(Slope = Regimen.slope, nk, Decision, Probability) %>% 
  arrange(Slope, nk, Decision) %>% 
  dplyr::select(-Slope) %>% 
  kable() %>% 
  kable_styling() %>% 
  group_rows(group_label = "Slope: -10%", start_row = 1, end_row = 8) %>% 
  group_rows(group_label = "Slope: 10%", start_row = 9, end_row = 17) %>% 
  group_rows(group_label = "Slope: 20%", start_row = 18, end_row = 26) %>% 
  group_rows(group_label = "Slope: 30%", start_row = 27, end_row = 34) %>% 
  group_rows(group_label = "Slope: 40%", start_row = 35, end_row = 41) 
```


### Varying LRV

Fixing the TV at 20%.

```{r barplot_decision-probabilities_even_varying-lrv, cache = TRUE, fig.width = 8, fig.height = 5}
theta_lrv <- as.list(seq(0,15,by = 3))
names(theta_lrv) <- theta_lrv
theta_tv <- as.list(rep(20,length(theta_lrv)))
names(theta_tv) <- theta_tv

output <- NULL
for (i in 1:length(theta_lrv)){
  temp <- mcmc_mods_even_30 %>% 
    map_dfr(
      # Convert to % relative to control
      ~mutate(.x, `Regimen 1` = ((arm2/arm1) - 1)*100,
              `Regimen 2` = ((arm3/arm1) - 1)*100,
              `Regimen 3` = ((arm4/arm1) - 1)*100,
              `Regimen 4` = ((arm5/arm1) - 1)*100) %>% 
        dplyr::select(`Regimen 1`:`Regimen 4`) %>% 
        pivot_longer(cols = 1:4,
                     names_to = "Regimen",
                     values_to = "Slope, %") %>% 
        group_by(Regimen) %>% 
        summarise(CI.025 = quantile(`Slope, %`, probs = tau_lrv),
                  CI.975 = quantile(`Slope, %`, probs = 1-tau_tv)) %>% 
        mutate(Decision = case_when(CI.975 < theta_tv[[i]] ~ "NO-GO", # If it doesn't have hope of reaching target value, it's stopped
                                    ((CI.025 > theta_lrv[[i]]) & (CI.975 > theta_tv[[i]])) ~ "GO", # if the CI includes TV and is entirely above the LRV, then it goes
                                    TRUE ~ "Continue")),
      .id = "sim") %>% 
    mutate(theta_tv = theta_tv[[i]],
           theta_lrv = theta_lrv[[i]])
  
  output <- bind_rows(output, temp)
}

output_neg10 <- NULL
for (i in 1:length(theta_lrv)){
  temp <- mcmc_mods_highlow_30 %>% 
    map_dfr(
      # Convert to % relative to control
      ~transmute(.x, `Regimen 5` = ((arm2/arm1) - 1)*100) %>% 
        pivot_longer(cols = 1,
                     names_to = "Regimen",
                     values_to = "Slope, %") %>% 
        group_by(Regimen) %>% 
        summarise(CI.025 = quantile(`Slope, %`, probs = tau_lrv),
                  CI.975 = quantile(`Slope, %`, probs = 1-tau_tv)) %>% 
        mutate(Decision = case_when(CI.975 < theta_tv[[i]] ~ "NO-GO", # If it doesn't have hope of reaching target value, it's stopped
                                    ((CI.025 > theta_lrv[[i]]) & (CI.975 > theta_tv[[i]])) ~ "GO", # if the CI includes TV and is entirely above the LRV, then it goes
                                    TRUE ~ "Continue")),
      .id = "sim") %>% 
    mutate(theta_tv = theta_tv[[i]],
           theta_lrv = theta_lrv[[i]])
  
  output_neg10 <- bind_rows(output_neg10, temp)
}


output %>% 
  bind_rows(output_neg10) %>% 
  group_by(Regimen, Decision, theta_lrv) %>% 
  summarise(n = n_distinct(sim)) %>% 
  group_by(Regimen, theta_lrv) %>% 
  mutate(Probability = n/sum(n),
         Decision = factor(Decision, levels = c("NO-GO", "Continue", "GO")),
         Regimen = case_when(Regimen == "Regimen 1" ~ "10% Slope Increase",
                             Regimen == "Regimen 2" ~ "20% Slope Increase",
                             Regimen == "Regimen 3" ~ "30% Slope Increase",
                             Regimen == "Regimen 4" ~ "40% Slope Increase",
                             TRUE ~ "-10% Slope Increase")) %>% 
  ggplot(aes(x = theta_lrv, y = Probability, fill = Decision)) + 
  facet_wrap(~Regimen, nrow = 1) +
  scale_fill_manual(values = c("red", ucsf_col_pal[8], ucsf_col_pal[4]),
                    breaks = c("NO-GO", "Continue", "GO"),
                    labels = c("NO-GO", "Continue", "GO")) +
  geom_bar(stat = "identity",
           alpha = 0.9) + 
  scale_y_continuous("Decision Probability",
                     breaks = seq(0,1,by = 0.1),
                     labels = seq(0,1,by = 0.1)) +
  scale_x_continuous(TeX("$\\theta_{LRV}$, %"),
                     breaks = seq(0,15,by = 3),
                     labels = seq(0,15,by = 3)) + 
  ggpubr::theme_pubr() + 
  ggtitle(TeX("Results from 1000 simulations, $n_k = 30$"), subtitle = TeX("$\\theta_{TV} = 20%$, $\\tau_{TV} = \\tau_{LRV} = 0.025$")) +
  theme(legend.position = "bottom")

```

### Varying TV

Fixing the LRV at 0%.

```{r barplot_decision-probabilities_even_varying-tv, cache = TRUE, fig.width = 8, fig.height = 5}
theta_tv <- as.list(seq(5,30,by=5))
names(theta_tv) <- theta_tv
theta_lrv <- as.list(rep(0,length(theta_tv)))
names(theta_lrv) <- theta_lrv

output <- NULL
for (i in 1:length(theta_lrv)){
  temp <- mcmc_mods_even_30 %>% 
    map_dfr(
      # Convert to % relative to control
      ~mutate(.x, `Regimen 1` = ((arm2/arm1) - 1)*100,
              `Regimen 2` = ((arm3/arm1) - 1)*100,
              `Regimen 3` = ((arm4/arm1) - 1)*100,
              `Regimen 4` = ((arm5/arm1) - 1)*100) %>% 
        dplyr::select(`Regimen 1`:`Regimen 4`) %>% 
        pivot_longer(cols = 1:4,
                     names_to = "Regimen",
                     values_to = "Slope, %") %>% 
        group_by(Regimen) %>% 
        summarise(CI.025 = quantile(`Slope, %`, probs = tau_lrv),
                  CI.975 = quantile(`Slope, %`, probs = 1-tau_tv)) %>% 
        mutate(Decision = case_when(CI.975 < theta_tv[[i]] ~ "NO-GO", # If it doesn't have hope of reaching target value, it's stopped
                                    ((CI.025 > theta_lrv[[i]]) & (CI.975 > theta_tv[[i]])) ~ "GO", # if the CI includes TV and is entirely above the LRV, then it goes
                                    TRUE ~ "Continue")),
      .id = "sim") %>% 
    mutate(theta_tv = theta_tv[[i]],
           theta_lrv = theta_lrv[[i]])
  
  output <- bind_rows(output, temp)
}

output_neg10 <- NULL
for (i in 1:length(theta_lrv)){
  temp <- mcmc_mods_highlow_30 %>% 
    map_dfr(
      # Convert to % relative to control
      ~transmute(.x, `Regimen 5` = ((arm2/arm1) - 1)*100) %>% 
        pivot_longer(cols = 1,
                     names_to = "Regimen",
                     values_to = "Slope, %") %>% 
        group_by(Regimen) %>% 
        summarise(CI.025 = quantile(`Slope, %`, probs = tau_lrv),
                  CI.975 = quantile(`Slope, %`, probs = 1-tau_tv)) %>% 
        mutate(Decision = case_when(CI.975 < theta_tv[[i]] ~ "NO-GO", # If it doesn't have hope of reaching target value, it's stopped
                                    ((CI.025 > theta_lrv[[i]]) & (CI.975 > theta_tv[[i]])) ~ "GO", # if the CI includes TV and is entirely above the LRV, then it goes
                                    TRUE ~ "Continue")),
      .id = "sim") %>% 
    mutate(theta_tv = theta_tv[[i]],
           theta_lrv = theta_lrv[[i]])
  
  output_neg10 <- bind_rows(output_neg10, temp)
}


output %>% 
  bind_rows(output_neg10) %>% 
  group_by(Regimen, Decision, theta_tv) %>% 
  summarise(n = n_distinct(sim)) %>% 
  group_by(Regimen, theta_tv) %>% 
  mutate(Probability = n/sum(n),
         Decision = factor(Decision, levels = c("NO-GO", "Continue", "GO")),
         Regimen = case_when(Regimen == "Regimen 1" ~ "10% Slope Increase",
                             Regimen == "Regimen 2" ~ "20% Slope Increase",
                             Regimen == "Regimen 3" ~ "30% Slope Increase",
                             Regimen == "Regimen 4" ~ "40% Slope Increase",
                             TRUE ~ "-10% Slope Increase")) %>% 
  ggplot(aes(x = theta_tv, y = Probability, fill = Decision)) + 
  facet_wrap(~Regimen, nrow = 1) +
  scale_fill_manual(values = c("red", ucsf_col_pal[8], ucsf_col_pal[4]),
                    breaks = c("NO-GO", "Continue", "GO"),
                    labels = c("NO-GO", "Continue", "GO")) +
  geom_bar(stat = "identity",
           alpha = 0.9) + 
  scale_y_continuous("Decision Probability",
                     breaks = seq(0,1,by = 0.1),
                     labels = seq(0,1,by = 0.1)) +
  scale_x_continuous(TeX("$\\theta_{TV}$, %"),
                     breaks = seq(5,30,by = 5),
                     labels = seq(5,30,by = 5)) + 
  ggpubr::theme_pubr() + 
  ggtitle(TeX("Results from 1000 simulations, $n_k = 30$"), subtitle = TeX("$\\theta_{LRV} = 0%$, $\\tau_{TV} = \\tau_{LRV} = 0.025$")) +
  theme(legend.position = "bottom")


```

### Varying false NO-GO risk

Fixing $\theta_{LRV} = 0$%, $\theta_{TV} = 20$%, and $\tau_{LRV} = 2.5$%.

```{r barplot_decision-probabilities_even_varying-tau-tv, cache = TRUE, fig.width = 8, fig.height = 5}
tau_tv <- as.list(c(.025, .05, .10, .15, .20))
names(tau_tv) <- tau_tv
tau_lrv <- as.list(rep(0.025,length(tau_tv)))
names(tau_lrv) <- tau_lrv

theta_tv <- 20
theta_lrv <- 0
library(furrr)
plan(multisession)

output <- NULL
for (i in 1:length(tau_lrv)){
  temp <- mcmc_mods_even_30 %>% 
    future_map_dfr(
      # Convert to % relative to control
      ~mutate(.x, `Regimen 1` = ((arm2/arm1) - 1)*100,
              `Regimen 2` = ((arm3/arm1) - 1)*100,
              `Regimen 3` = ((arm4/arm1) - 1)*100,
              `Regimen 4` = ((arm5/arm1) - 1)*100) %>% 
        dplyr::select(`Regimen 1`:`Regimen 4`) %>% 
        pivot_longer(cols = 1:4,
                     names_to = "Regimen",
                     values_to = "Slope, %") %>% 
        group_by(Regimen) %>% 
        summarise(CI.025 = quantile(`Slope, %`, probs = tau_lrv[[i]]),
                  CI.975 = quantile(`Slope, %`, probs = 1-tau_tv[[i]])) %>% 
        mutate(Decision = case_when(CI.975 < theta_tv ~ "NO-GO", # If it doesn't have hope of reaching target value, it's stopped
                                    ((CI.025 > theta_lrv) & (CI.975 > theta_tv)) ~ "GO", # if the CI includes TV and is entirely above the LRV, then it goes
                                    TRUE ~ "Continue")),
      .id = "sim") %>% 
    mutate(tau_tv = tau_tv[[i]],
           tau_lrv = tau_lrv[[i]])
  
  output <- bind_rows(output, temp)
}

output_neg10 <- NULL
for (i in 1:length(tau_lrv)){
  temp <- mcmc_mods_highlow_30 %>% 
    future_map_dfr(
      # Convert to % relative to control
      ~transmute(.x, `Regimen 5` = ((arm2/arm1) - 1)*100) %>% 
        pivot_longer(cols = 1,
                     names_to = "Regimen",
                     values_to = "Slope, %") %>% 
        group_by(Regimen) %>% 
        summarise(CI.025 = quantile(`Slope, %`, probs = tau_lrv[[i]]),
                  CI.975 = quantile(`Slope, %`, probs = 1-tau_tv[[i]])) %>% 
        mutate(Decision = case_when(CI.975 < theta_tv ~ "NO-GO", # If it doesn't have hope of reaching target value, it's stopped
                                    ((CI.025 > theta_lrv) & (CI.975 > theta_tv)) ~ "GO", # if the CI includes TV and is entirely above the LRV, then it goes
                                    TRUE ~ "Continue")),
      .id = "sim") %>% 
    mutate(tau_tv = tau_tv[[i]],
           tau_lrv = tau_lrv[[i]])
  
  output_neg10 <- bind_rows(output_neg10, temp)
}


output %>% 
  bind_rows(output_neg10) %>% 
  group_by(Regimen, Decision, tau_tv) %>% 
  summarise(n = n_distinct(sim)) %>% 
  group_by(Regimen, tau_tv) %>% 
  mutate(Probability = n/sum(n),
         Decision = factor(Decision, levels = c("NO-GO", "Continue", "GO")),
         Regimen = case_when(Regimen == "Regimen 1" ~ "10% Slope Increase",
                             Regimen == "Regimen 2" ~ "20% Slope Increase",
                             Regimen == "Regimen 3" ~ "30% Slope Increase",
                             Regimen == "Regimen 4" ~ "40% Slope Increase",
                             TRUE ~ "-10% Slope Increase")) %>% 
  mutate(tau_tv = as.factor(tau_tv)) %>% 
  ggplot(aes(x = tau_tv, y = Probability, fill = Decision)) + 
  facet_wrap(~Regimen, nrow = 1) +
  scale_fill_manual(values = c("red", ucsf_col_pal[8], ucsf_col_pal[4]),
                    breaks = c("NO-GO", "Continue", "GO"),
                    labels = c("NO-GO", "Continue", "GO")) +
  geom_bar(stat = "identity",
           alpha = 0.9) + 
  scale_y_continuous("Decision Probability",
                     breaks = seq(0,1,by = 0.1),
                     labels = seq(0,1,by = 0.1)) +
  scale_x_discrete(TeX("$\\tau_{TV}$, %"),
                  #   breaks = c(.025, .05, .10, .15, .20),
                     labels = c(2.5, 5, 10, 15, 20)) + 
  ggpubr::theme_pubr() + 
  ggtitle(TeX("Results from 1000 simulations, $n_k = 30$"), subtitle = TeX("$\\theta_{LRV} = 0%$, $\\theta_{TV} = 20%$, $\\tau_{LRV} = 0.025$")) +
  theme(legend.position = "bottom")
```

### Varying false GO risk

Fixing $\theta_{LRV} = 0$%, $\theta_{TV} = 20$%, and $\tau_{TV} = 2.5$%.

```{r barplot_decision-probabilities_even_varying-tau-lrv, cache = TRUE, fig.width = 8, fig.height = 5}
tau_lrv <- as.list(c(.025, .05, .10, .15, .20))
names(tau_lrv) <- tau_lrv
tau_tv <- as.list(rep(0.025,length(tau_lrv)))
names(tau_tv) <- tau_tv

theta_tv <- 20
theta_lrv <- 0
plan(multisession)

output <- NULL
for (i in 1:length(tau_lrv)){
  temp <- mcmc_mods_even_30 %>% 
    future_map_dfr(
      # Convert to % relative to control
      ~mutate(.x, `Regimen 1` = ((arm2/arm1) - 1)*100,
              `Regimen 2` = ((arm3/arm1) - 1)*100,
              `Regimen 3` = ((arm4/arm1) - 1)*100,
              `Regimen 4` = ((arm5/arm1) - 1)*100) %>% 
        dplyr::select(`Regimen 1`:`Regimen 4`) %>% 
        pivot_longer(cols = 1:4,
                     names_to = "Regimen",
                     values_to = "Slope, %") %>% 
        group_by(Regimen) %>% 
        summarise(CI.025 = quantile(`Slope, %`, probs = tau_lrv[[i]]),
                  CI.975 = quantile(`Slope, %`, probs = 1-tau_tv[[i]])) %>% 
        mutate(Decision = case_when(CI.975 < theta_tv ~ "NO-GO", # If it doesn't have hope of reaching target value, it's stopped
                                    ((CI.025 > theta_lrv) & (CI.975 > theta_tv)) ~ "GO", # if the CI includes TV and is entirely above the LRV, then it goes
                                    TRUE ~ "Continue")),
      .id = "sim") %>% 
    mutate(tau_tv = tau_tv[[i]],
           tau_lrv = tau_lrv[[i]])
  
  output <- bind_rows(output, temp)
}

output_neg10 <- NULL
for (i in 1:length(tau_lrv)){
  temp <- mcmc_mods_highlow_30 %>% 
    future_map_dfr(
      # Convert to % relative to control
      ~transmute(.x, `Regimen 5` = ((arm2/arm1) - 1)*100) %>% 
        pivot_longer(cols = 1,
                     names_to = "Regimen",
                     values_to = "Slope, %") %>% 
        group_by(Regimen) %>% 
        summarise(CI.025 = quantile(`Slope, %`, probs = tau_lrv[[i]]),
                  CI.975 = quantile(`Slope, %`, probs = 1-tau_tv[[i]])) %>% 
        mutate(Decision = case_when(CI.975 < theta_tv ~ "NO-GO", # If it doesn't have hope of reaching target value, it's stopped
                                    ((CI.025 > theta_lrv) & (CI.975 > theta_tv)) ~ "GO", # if the CI includes TV and is entirely above the LRV, then it goes
                                    TRUE ~ "Continue")),
      .id = "sim") %>% 
    mutate(tau_tv = tau_tv[[i]],
           tau_lrv = tau_lrv[[i]])
  
  output_neg10 <- bind_rows(output_neg10, temp)
}


output %>% 
  bind_rows(output_neg10) %>% 
  group_by(Regimen, Decision, tau_lrv) %>% 
  summarise(n = n_distinct(sim)) %>% 
  group_by(Regimen, tau_lrv) %>% 
  mutate(Probability = n/sum(n),
         Decision = factor(Decision, levels = c("NO-GO", "Continue", "GO")),
         Regimen = case_when(Regimen == "Regimen 1" ~ "10% Slope Increase",
                             Regimen == "Regimen 2" ~ "20% Slope Increase",
                             Regimen == "Regimen 3" ~ "30% Slope Increase",
                             Regimen == "Regimen 4" ~ "40% Slope Increase",
                             TRUE ~ "-10% Slope Increase")) %>% 
  mutate(tau_tv = as.factor(tau_lrv)) %>% 
  ggplot(aes(x = tau_tv, y = Probability, fill = Decision)) + 
  facet_wrap(~Regimen, nrow = 1) +
  scale_fill_manual(values = c("red", ucsf_col_pal[8], ucsf_col_pal[4]),
                    breaks = c("NO-GO", "Continue", "GO"),
                    labels = c("NO-GO", "Continue", "GO")) +
  geom_bar(stat = "identity",
           alpha = 0.9) + 
  scale_y_continuous("Decision Probability",
                     breaks = seq(0,1,by = 0.1),
                     labels = seq(0,1,by = 0.1)) +
  scale_x_discrete(TeX("$\\tau_{LRV}$, %"),
                  #   breaks = c(.025, .05, .10, .15, .20),
                     labels = c(2.5, 5, 10, 15, 20)) + 
  ggpubr::theme_pubr() + 
  ggtitle(TeX("Results from 1000 simulations, $n_k = 30$"), subtitle = TeX("$\\theta_{LRV} = 0%$, $\\theta_{TV} = 20%$, $\\tau_{TV} = 0.025$")) +
  theme(legend.position = "bottom")
```

