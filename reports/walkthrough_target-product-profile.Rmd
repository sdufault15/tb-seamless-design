---
title: "Target Product Profile"
author: "Suzanne Dufault"
date: "`r Sys.Date()"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      warning = FALSE,
                      message = FALSE,
                      fig.path = "../graphs/")

library(tidyverse)
library(here)
library(latex2exp)
source(here("lib","ucsf-color-palette.R"))

load("~/OneDrive - University of California, San Francisco/ucsf-research/phase2b-simstudy/data/cleaned-results/2022-02-25_mcmc-mods-even-30.RData")
load("~/OneDrive - University of California, San Francisco/ucsf-research/phase2b-simstudy/data/cleaned-results/2022-02-25_mcmc-mods-even-40.RData")
load("~/OneDrive - University of California, San Francisco/ucsf-research/phase2b-simstudy/data/cleaned-results/2022-02-25_mcmc-mods-even-20.RData")
```

# Target Product Profile Walk-Through {.tabset}

Using notation from Pulkstenis et al. The target product profile (TPP) requires the specification of four primary quantities of interest:

+ $\theta_{LRV}$: **lower reference value**, the minimal level of acceptable efficacy
  + $\tau_{LRV}$: **false GO rate**, the maximum allowable risk that you advance a regimen that does not reach the minimal level of acceptable efficacy
+ $\theta_{TV}$: **target value**, the level of efficacy corresponding to solid competitiveness
  + $\tau_{TV}$: **false NO-GO rate**, the maximum allowable risk that you stop a regimen that does have solid competitiveness
  
```{r}
theta_lrv <- 0 # lower reference value
theta_tv <- 20 # target value
tau_tv <- 0.025 # false no-go risk
tau_lrv <- 0.025 # false go risk
```
  
## Single Example

In a single study, we can visualize this in a handful of ways. Below is an example from the simulated data comparing 4 novel regimens against a control with 30 participants assigned per regimen. **Panel A** shows the posterior distributions for the estimated % increase in log10(TTP) slope of each regimen relative to the control regimen. **Panel B** shows the Bayesian credible intervals for each regimen. These are used for decision-making.

In this example:

+ $\theta_{LRV} =$ 0% 
+ $\theta_{TV}=$ 20%
+ $\tau_{LRV} = \tau_{TV} = 2.5$%

```{r tpp-posterior-distribution-example, fig.width = 10, fig.height = 5, fig.cap = "Recreation of Figure 1 from Pulkstenis et al."}
  # Convert to % relative to control
p1 <- mcmc_mods_even_30[[1]] %>% 
  mutate(`Regimen 1` = ((arm2/arm1) - 1)*100,
         `Regimen 2` = ((arm3/arm1) - 1)*100,
         `Regimen 3` = ((arm4/arm1) - 1)*100,
         `Regimen 4` = ((arm5/arm1) - 1)*100) %>% 
  dplyr::select(`Regimen 1`:`Regimen 4`) %>% 
  pivot_longer(cols = 1:4,
               names_to = "Regimen",
               values_to = "Slope, %") %>% 
  ggplot(aes(x = `Slope, %`, fill = Regimen)) + 
  geom_density(alpha = 0.3,
               col = "white") + 
  ggpubr::theme_pubr() +
  geom_segment(aes(x = theta_lrv, xend = theta_lrv, y = 0, yend = 0.05), lty = 2) + 
  geom_segment(aes(x = theta_tv, xend = theta_tv, y = 0, yend = 0.05), lty = 2) + 
  annotate(geom = "text", x = theta_lrv, y = 0.051, label = TeX("$\\theta_{LRV}$"), vjust = 0) +
  annotate(geom = "text", x = theta_tv, y = 0.051, label = TeX("$\\theta_{TV}$"), vjust = 0) +
  annotate(geom = "text", x = -18, y = -0.001, label = "Minimal Case", hjust = 0) +
  annotate(geom = "text", x = 10, y = -0.001, label = "Lower Case") +
  annotate(geom = "text", x = 30, y = -0.001, label = "Target Case") + 
  scale_x_continuous(breaks = seq(-30,100,by = 10),
                     labels = seq(-30,100,by = 10)) +
  scale_fill_manual(values = ucsf_col_pal) + 
  theme(axis.title = element_blank(),
        legend.position = "bottom")

  # Convert to % relative to control
p2 <- mcmc_mods_even_30[[1]] %>% 
  mutate(`Regimen 1` = ((arm2/arm1) - 1)*100,
         `Regimen 2` = ((arm3/arm1) - 1)*100,
         `Regimen 3` = ((arm4/arm1) - 1)*100,
         `Regimen 4` = ((arm5/arm1) - 1)*100) %>% 
  dplyr::select(`Regimen 1`:`Regimen 4`) %>% 
  pivot_longer(cols = 1:4,
               names_to = "Regimen",
               values_to = "Slope, %") %>% 
  group_by(Regimen) %>% 
  summarise(CI.025 = quantile(`Slope, %`, probs = tau_lrv),
            CI.975 = quantile(`Slope, %`, probs = 1-tau_tv)) %>% 
  mutate(Decision = case_when(CI.975 < theta_tv ~ "NO-GO", # If it doesn't have hope of reaching target value, it's stopped
                              ((CI.025 > theta_lrv) & (CI.975 > theta_tv)) ~ "GO", # if the CI includes TV and is entirely above the LRV, then it goes
                              TRUE ~ "Consider")) %>% 
  mutate(Decision = factor(Decision, levels = c("NO-GO", "Consider", "GO"))) %>% 
  ungroup() %>% 
  mutate(nr = row_number()) %>% 
  ggplot() + 
  geom_segment(aes(y = nr, yend = nr, 
                   x = CI.025, xend = CI.975, 
                   col = Decision),
               lwd = 1) + 
  ggpubr::theme_pubr() + 
  geom_segment(aes(x = 0, xend = 0, y = 0, yend = 4.45), lty = 2) + 
  scale_color_manual(values = c(ucsf_col_pal[4], ucsf_col_pal[8], "red"),
                     breaks = c("GO", "Consider", "NO-GO"),
                     labels = c("GO", "Consider", "NO-GO"),
                     drop = FALSE) +
  geom_segment(aes(x = 20, xend = 20, y = 0, yend = 4.45), lty = 2) + 
  annotate(geom = "text", x = 0, y = -0.1, label = TeX("$\\theta_{LRV}$"), vjust = 0) +
  annotate(geom = "text", x = 20, y = -0.1, label = TeX("$\\theta_{TV}$"), vjust = 0) +
  scale_x_continuous("95% Credible Interval on Relative Slope, %", 
                     breaks = seq(0,100,by = 10),
                     labels = seq(0,100,by = 10)) +
  scale_y_continuous(breaks = 1:4,
                     labels = paste0("Regimen ", 1:4)) +
  theme(axis.title.y = element_blank(),
        legend.position = "bottom")

ggpubr::ggarrange(p1, p2, nrow = 1, widths = c(3,2))
```

## Across Simulations

```{r barplot_decision-probabilities, fig.width = 8, fig.height = 4}
decisions <- mcmc_mods_even_30 %>% 
  map_dfr(
    # Convert to % relative to control
    ~mutate(.x, `Regimen 1` = ((arm2/arm1) - 1)*100,
            `Regimen 2` = ((arm3/arm1) - 1)*100,
            `Regimen 3` = ((arm4/arm1) - 1)*100,
            `Regimen 4` = ((arm5/arm1) - 1)*100) %>% 
      dplyr::select(`Regimen 1`:`Regimen 4`) %>% 
      pivot_longer(cols = 1:4,
                   names_to = "Regimen",
                   values_to = "Slope, %") %>% 
      group_by(Regimen) %>% 
      summarise(CI.025 = quantile(`Slope, %`, probs = tau_lrv),
                CI.975 = quantile(`Slope, %`, probs = 1-tau_tv)) %>% 
      mutate(Decision = case_when(CI.975 < theta_tv ~ "NO-GO", # If it doesn't have hope of reaching target value, it's stopped
                                  ((CI.025 > theta_lrv) & (CI.975 > theta_tv)) ~ "GO", # if the CI includes TV and is entirely above the LRV, then it goes
                                  TRUE ~ "Consider")),
    .id = "sim")

decisions_40 <- mcmc_mods_even_40 %>% 
  map_dfr(
    # Convert to % relative to control
    ~mutate(.x, `Regimen 1` = ((arm2/arm1) - 1)*100,
            `Regimen 2` = ((arm3/arm1) - 1)*100,
            `Regimen 3` = ((arm4/arm1) - 1)*100,
            `Regimen 4` = ((arm5/arm1) - 1)*100) %>% 
      dplyr::select(`Regimen 1`:`Regimen 4`) %>% 
      pivot_longer(cols = 1:4,
                   names_to = "Regimen",
                   values_to = "Slope, %") %>% 
      group_by(Regimen) %>% 
      summarise(CI.025 = quantile(`Slope, %`, probs = tau_lrv),
                CI.975 = quantile(`Slope, %`, probs = 1-tau_tv)) %>% 
      mutate(Decision = case_when(CI.975 < theta_tv ~ "NO-GO", # If it doesn't have hope of reaching target value, it's stopped
                                  ((CI.025 > theta_lrv) & (CI.975 > theta_tv)) ~ "GO", # if the CI includes TV and is entirely above the LRV, then it goes
                                  TRUE ~ "Consider")),
    .id = "sim")

decisions_20 <- mcmc_mods_even_20 %>% 
  map_dfr(
    # Convert to % relative to control
    ~mutate(.x, `Regimen 1` = ((arm2/arm1) - 1)*100,
            `Regimen 2` = ((arm3/arm1) - 1)*100,
            `Regimen 3` = ((arm4/arm1) - 1)*100,
            `Regimen 4` = ((arm5/arm1) - 1)*100) %>% 
      dplyr::select(`Regimen 1`:`Regimen 4`) %>% 
      pivot_longer(cols = 1:4,
                   names_to = "Regimen",
                   values_to = "Slope, %") %>% 
      group_by(Regimen) %>% 
      summarise(CI.025 = quantile(`Slope, %`, probs = tau_lrv),
                CI.975 = quantile(`Slope, %`, probs = 1-tau_tv)) %>% 
      mutate(Decision = case_when(CI.975 < theta_tv ~ "NO-GO", # If it doesn't have hope of reaching target value, it's stopped
                                  ((CI.025 > theta_lrv) & (CI.975 > theta_tv)) ~ "GO", # if the CI includes TV and is entirely above the LRV, then it goes
                                  TRUE ~ "Consider")),
    .id = "sim")

p3 <- decisions %>% 
  group_by(Regimen, Decision) %>% 
  summarise(n = n_distinct(sim)) %>% 
  group_by(Regimen) %>% 
  mutate(Probability = n/sum(n),
         Decision = factor(Decision, levels = c("NO-GO", "Consider", "GO"))) %>% 
  ggplot(aes(x = Regimen, y = Probability, fill = Decision)) + 
  scale_fill_manual(values = c("red", ucsf_col_pal[8], ucsf_col_pal[4]),
                    breaks = c("NO-GO", "Consider", "GO"),
                    labels = c("NO-GO", "Consider", "GO")) +
  geom_bar(stat = "identity",
           alpha = 0.9) + 
  scale_y_continuous("Decision Probability",
                     breaks = seq(0,1,by = 0.1),
                     labels = seq(0,1,by = 0.1)) +
  scale_x_discrete("Relative Slope, %",
                   labels = c("10%", "20%", "30%", "40%")) + 
  ggpubr::theme_pubr() + 
  ggtitle(TeX("Results from 1000 simulations, $n_k = 30$"), subtitle = TeX("$\\theta_{LRV} = 0%$, $\\theta_{TV} = 20%$, $\\tau_{TV} = \\tau_{LRV} = 0.025$")) +
  theme(legend.position = "bottom")

p4 <- decisions_40 %>% 
  group_by(Regimen, Decision) %>% 
  summarise(n = n_distinct(sim)) %>% 
  group_by(Regimen) %>% 
  mutate(Probability = n/sum(n),
         Decision = factor(Decision, levels = c("NO-GO", "Consider", "GO"))) %>% 
  ggplot(aes(x = Regimen, y = Probability, fill = Decision)) + 
  scale_fill_manual(values = c("red", ucsf_col_pal[8], ucsf_col_pal[4]),
                    breaks = c("NO-GO", "Consider", "GO"),
                    labels = c("NO-GO", "Consider", "GO")) +
  geom_bar(stat = "identity",
           alpha = 0.9) + 
  scale_y_continuous("Decision Probability",
                     breaks = seq(0,1,by = 0.1),
                     labels = seq(0,1,by = 0.1)) +
  scale_x_discrete("Relative Slope, %",
                   labels = c("10%", "20%", "30%", "40%")) + 
  ggpubr::theme_pubr() + 
  ggtitle(TeX("Results from 1000 simulations, $n_k = 40$"), subtitle = TeX("$\\theta_{LRV} = 0%$, $\\theta_{TV} = 20%$, $\\tau_{TV} = \\tau_{LRV} = 0.025$")) +
  theme(legend.position = "bottom")


p5 <- decisions_20 %>% 
  group_by(Regimen, Decision) %>% 
  summarise(n = n_distinct(sim)) %>% 
  group_by(Regimen) %>% 
  mutate(Probability = n/sum(n),
         Decision = factor(Decision, levels = c("NO-GO", "Consider", "GO"))) %>% 
  ggplot(aes(x = Regimen, y = Probability, fill = Decision)) + 
  scale_fill_manual(values = c("red", ucsf_col_pal[8], ucsf_col_pal[4]),
                    breaks = c("NO-GO", "Consider", "GO"),
                    labels = c("NO-GO", "Consider", "GO")) +
  geom_bar(stat = "identity",
           alpha = 0.9) + 
  scale_y_continuous("Decision Probability",
                     breaks = seq(0,1,by = 0.1),
                     labels = seq(0,1,by = 0.1)) +
  scale_x_discrete("Relative Slope, %",
                   labels = c("10%", "20%", "30%", "40%")) + 
  ggpubr::theme_pubr() + 
  ggtitle(TeX("Results from 1000 simulations, $n_k = 20$"), subtitle = TeX("$\\theta_{LRV} = 0%$, $\\theta_{TV} = 20%$, $\\tau_{TV} = \\tau_{LRV} = 0.025$")) +
  theme(legend.position = "bottom")

ggpubr::ggarrange(p5, p3, p4, nrow = 1)
```
