---
title: "Phase IIB Seamless Simulation Study Results"
author: "Suzanne Dufault"
date: "`r Sys.Date()`"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      warning = FALSE,
                      message = FALSE,
                      fig.path = "../graphs/simulation-results/")

library(tidyverse)
library(here)
library(kableExtra)
library(knitr)
options(knitr.kable.NA = '')
source(here("lib", "ucsf-color-palette.R"))
```

```{r log10ttp-data}
# load(here("data","bayes-generated","2022-02-18_mcmc-mods_even_30_100.RData")) # this is the corresponding result for the sample dataset
# 
# mcmc_m1 <- mcmc_mods_even_30[[1]] # for demonstration
```


## Simulation Study Results {.tabset}

### Conditions {.tabset .tabset-pills}

#### Survival Conditions

| Setting | Regimen | Characteristics |
|:-------:|:-------:|:----------------|
| 1 | 2 | suboptimal, relapse rate is twice that of the control regimen |
| | 3,4 | minimal, relapse rate is the same as the control regimen |
| | 5 | desirable, relapse rate is half that of the control regimen |
| | | | |
| 2 | 2-5 | all are desirable, relapse rate is half that of the control regimen |
| 3 | 2-5 | all are minimal, relapse rate is the same as the control regimen |

```{r}
knitr::include_graphics(here("graphs", "simulation-settings", "2022-03-03_survival-curve-mixed.jpg"))
knitr::include_graphics(here("graphs", "simulation-settings", "2022-03-03_survival-curve-all-desirable.jpg"))
knitr::include_graphics(here("graphs", "simulation-settings", "2022-03-03_survival-curve-all-minimal.jpg"))
```

#### log10(TTP) conditions

+ For each treatment arm, we will do a handful of hypothetical intervention effect sizes. These will be specified as percent change in slope *as compared to the control*.   
  + $\{10\%,20\%,30\%,40\%\}$ (even relative increases by treatment arm)
  + $\{-10\%,10\%,35\%,40\%\}$ (two are near the control arm, two are better. Can we distinguish the best?)
  + $\{35\%, 37\%, 39\%, 41\%\}$

![Visualization of conditions](../../phase2b-simstudy/graphs/simulation-results/lineplot_simulation-conditions-1.png)

### Simulation Results {.tabset}

#### Log10(TTP) Only {.tabset}

```{r ttp-data}
load(here("data", "analyzed", "2022-03-07_sim-level-ttp-results_nk30_4mo-duration.RData"))
simlevel_ttp30 <- simlevel_ttp
load(here("data", "analyzed", "2022-03-07_sim-level-ttp-results_nk40_4mo-duration.RData"))
simlevel_ttp40 <- simlevel_ttp
load(here("data", "analyzed", "2022-03-07_sim-level-ttp-results_nk60_4mo-duration.RData"))
simlevel_ttp60 <- simlevel_ttp
load(here("data", "analyzed", "2022-03-07_sim-level-ttp-results_nk80_4mo-duration.RData"))
simlevel_ttp80 <- simlevel_ttp
```

For the sake of this simulation study, we will consider dropping regimens that fail to meet the following criteria:

1. $\pi(\mu_k > \mu) \geq \alpha_1$. The probability that the slope for regimen $k$ is greater than the control slope must be at least $\alpha_1 = \{0.8, 0.9, 0.95\}$

##### 30 per regimen

```{r ttp-tab30}
t30a <- simlevel_ttp30$even_ttp %>% 
  group_by(arm) %>% 
  summarise(`P(better than control) > 0.8 and P(in top 2) > 0.8` = mean(continues.2criteria),
            `P(better than control) > 0.8` = mean(continues.1criteria.80),
            `P(better than control) > 0.9` = mean(continues.1criteria.90),
            `P(better than control) > 0.95` = mean(continues.1criteria.95)) %>% 
  mutate(arm = case_when(arm == "arm2" ~ "10%",
                         arm == "arm3" ~ "20%",
                         arm == "arm4" ~ "30%",
                         arm == "arm5" ~ "40%",
                         TRUE ~ arm))
t30b <- simlevel_ttp30$high_ttp %>% 
  group_by(arm) %>% 
  summarise(`P(better than control) > 0.8 and P(in top 2) > 0.8` = mean(continues.2criteria),
            `P(better than control) > 0.8` = mean(continues.1criteria.80),
            `P(better than control) > 0.9` = mean(continues.1criteria.90),
            `P(better than control) > 0.95` = mean(continues.1criteria.95)) %>% 
  mutate(arm = case_when(arm == "arm2" ~ "35%",
                         arm == "arm3" ~ "37%",
                         arm == "arm4" ~ "39%",
                         arm == "arm5" ~ "41%",
                         TRUE ~ arm))
t30c <- simlevel_ttp30$highlow_ttp %>% 
  group_by(arm) %>% 
  summarise(`P(better than control) > 0.8 and P(in top 2) > 0.8` = mean(continues.2criteria),
            `P(better than control) > 0.8` = mean(continues.1criteria.80),
            `P(better than control) > 0.9` = mean(continues.1criteria.90),
            `P(better than control) > 0.95` = mean(continues.1criteria.95)) %>% 
  mutate(arm = case_when(arm == "arm2" ~ "-10%",
                         arm == "arm3" ~ "10%",
                         arm == "arm4" ~ "35%",
                         arm == "arm5" ~ "40%",
                         TRUE ~ arm))

bind_rows(t30a, t30b,t30c) %>% 
  mutate(arm = case_when(arm == "arm1" ~ "ref",
                         TRUE ~ arm)) %>% 
  rename("Log10(TTP) Characteristics" = arm) %>% 
  kable(digits = 2) %>% 
  kable_styling() %>% 
  add_header_above(c("30 per regimen" = 1, "P(Continues based off of log10(TTP))" = 4)) %>% 
  group_rows(group_label = "Slopes are evenly distributed", start_row = 1, end_row = 5) %>% 
  group_rows(group_label = "Slopes are clustered high", start_row = 6, end_row = 10) %>% 
  group_rows(group_label = "Slopes are clustered high and low", start_row = 11, end_row = 15)
```


##### 40 per regimen

```{r ttp-tab40}
t40a <- simlevel_ttp40$even_ttp %>% 
  group_by(arm) %>% 
  summarise(`P(better than control) > 0.8 and P(in top 2) > 0.8` = mean(continues.2criteria),
            `P(better than control) > 0.8` = mean(continues.1criteria.80),
            `P(better than control) > 0.9` = mean(continues.1criteria.90),
            `P(better than control) > 0.95` = mean(continues.1criteria.95)) %>% 
  mutate(arm = case_when(arm == "arm2" ~ "10%",
                         arm == "arm3" ~ "20%",
                         arm == "arm4" ~ "30%",
                         arm == "arm5" ~ "40%",
                         TRUE ~ arm))
t40b <- simlevel_ttp40$high_ttp %>% 
  group_by(arm) %>% 
  summarise(`P(better than control) > 0.8 and P(in top 2) > 0.8` = mean(continues.2criteria),
            `P(better than control) > 0.8` = mean(continues.1criteria.80),
            `P(better than control) > 0.9` = mean(continues.1criteria.90),
            `P(better than control) > 0.95` = mean(continues.1criteria.95)) %>% 
  mutate(arm = case_when(arm == "arm2" ~ "35%",
                         arm == "arm3" ~ "37%",
                         arm == "arm4" ~ "39%",
                         arm == "arm5" ~ "41%",
                         TRUE ~ arm))
t40c <- simlevel_ttp40$highlow_ttp %>% 
  group_by(arm) %>% 
  summarise(`P(better than control) > 0.8 and P(in top 2) > 0.8` = mean(continues.2criteria),
            `P(better than control) > 0.8` = mean(continues.1criteria.80),
            `P(better than control) > 0.9` = mean(continues.1criteria.90),
            `P(better than control) > 0.95` = mean(continues.1criteria.95)) %>% 
  mutate(arm = case_when(arm == "arm2" ~ "-10%",
                         arm == "arm3" ~ "10%",
                         arm == "arm4" ~ "35%",
                         arm == "arm5" ~ "40%",
                         TRUE ~ arm))

bind_rows(t40a, t40b,t40c) %>% 
  mutate(arm = case_when(arm == "arm1" ~ "ref",
                         TRUE ~ arm)) %>% 
  rename("Log10(TTP) Characteristics" = arm) %>% 
  kable(digits = 2) %>% 
  kable_styling() %>% 
  add_header_above(c("40 per regimen" = 1, "P(Continues based off of log10(TTP))" = 4)) %>% 
  group_rows(group_label = "Slopes are evenly distributed", start_row = 1, end_row = 5) %>% 
  group_rows(group_label = "Slopes are clustered high", start_row = 6, end_row = 10) %>% 
  group_rows(group_label = "Slopes are clustered high and low", start_row = 11, end_row = 15)
```


##### 60 per regimen

```{r ttp-tab60}
t60a <- simlevel_ttp60$even_ttp %>% 
  group_by(arm) %>% 
  summarise(`P(better than control) > 0.8 and P(in top 2) > 0.8` = mean(continues.2criteria),
            `P(better than control) > 0.8` = mean(continues.1criteria.80),
            `P(better than control) > 0.9` = mean(continues.1criteria.90),
            `P(better than control) > 0.95` = mean(continues.1criteria.95)) %>% 
  mutate(arm = case_when(arm == "arm2" ~ "10%",
                         arm == "arm3" ~ "20%",
                         arm == "arm4" ~ "60%",
                         arm == "arm5" ~ "40%",
                         TRUE ~ arm))
t60b <- simlevel_ttp60$high_ttp %>% 
  group_by(arm) %>% 
  summarise(`P(better than control) > 0.8 and P(in top 2) > 0.8` = mean(continues.2criteria),
            `P(better than control) > 0.8` = mean(continues.1criteria.80),
            `P(better than control) > 0.9` = mean(continues.1criteria.90),
            `P(better than control) > 0.95` = mean(continues.1criteria.95)) %>% 
  mutate(arm = case_when(arm == "arm2" ~ "35%",
                         arm == "arm3" ~ "37%",
                         arm == "arm4" ~ "39%",
                         arm == "arm5" ~ "41%",
                         TRUE ~ arm))
t60c <- simlevel_ttp60$highlow_ttp %>% 
  group_by(arm) %>% 
  summarise(`P(better than control) > 0.8 and P(in top 2) > 0.8` = mean(continues.2criteria),
            `P(better than control) > 0.8` = mean(continues.1criteria.80),
            `P(better than control) > 0.9` = mean(continues.1criteria.90),
            `P(better than control) > 0.95` = mean(continues.1criteria.95)) %>% 
  mutate(arm = case_when(arm == "arm2" ~ "-10%",
                         arm == "arm3" ~ "10%",
                         arm == "arm4" ~ "35%",
                         arm == "arm5" ~ "40%",
                         TRUE ~ arm))

bind_rows(t60a, t60b,t60c) %>% 
  mutate(arm = case_when(arm == "arm1" ~ "ref",
                         TRUE ~ arm)) %>% 
  rename("Log10(TTP) Characteristics" = arm) %>% 
  kable(digits = 2) %>% 
  kable_styling() %>% 
  add_header_above(c("60 per regimen" = 1, "P(Continues based off of log10(TTP))" = 4)) %>% 
  group_rows(group_label = "Slopes are evenly distributed", start_row = 1, end_row = 5) %>% 
  group_rows(group_label = "Slopes are clustered high", start_row = 6, end_row = 10) %>% 
  group_rows(group_label = "Slopes are clustered high and low", start_row = 11, end_row = 15)
```

##### 80 per regimen

```{r ttp-tab80}
t80a <- simlevel_ttp80$even_ttp %>% 
  group_by(arm) %>% 
  summarise(`P(better than control) > 0.8 and P(in top 2) > 0.8` = mean(continues.2criteria),
            `P(better than control) > 0.8` = mean(continues.1criteria.80),
            `P(better than control) > 0.9` = mean(continues.1criteria.90),
            `P(better than control) > 0.95` = mean(continues.1criteria.95)) %>% 
  mutate(arm = case_when(arm == "arm2" ~ "10%",
                         arm == "arm3" ~ "20%",
                         arm == "arm4" ~ "30%",
                         arm == "arm5" ~ "40%",
                         TRUE ~ arm))
t80b <- simlevel_ttp80$high_ttp %>% 
  group_by(arm) %>% 
  summarise(`P(better than control) > 0.8 and P(in top 2) > 0.8` = mean(continues.2criteria),
            `P(better than control) > 0.8` = mean(continues.1criteria.80),
            `P(better than control) > 0.9` = mean(continues.1criteria.90),
            `P(better than control) > 0.95` = mean(continues.1criteria.95)) %>% 
  mutate(arm = case_when(arm == "arm2" ~ "35%",
                         arm == "arm3" ~ "37%",
                         arm == "arm4" ~ "39%",
                         arm == "arm5" ~ "41%",
                         TRUE ~ arm))
t80c <- simlevel_ttp80$highlow_ttp %>% 
  group_by(arm) %>% 
  summarise(`P(better than control) > 0.8 and P(in top 2) > 0.8` = mean(continues.2criteria),
            `P(better than control) > 0.8` = mean(continues.1criteria.80),
            `P(better than control) > 0.9` = mean(continues.1criteria.90),
            `P(better than control) > 0.95` = mean(continues.1criteria.95)) %>% 
  mutate(arm = case_when(arm == "arm2" ~ "-10%",
                         arm == "arm3" ~ "10%",
                         arm == "arm4" ~ "35%",
                         arm == "arm5" ~ "40%",
                         TRUE ~ arm))

bind_rows(t80a, t80b,t80c) %>% 
  mutate(arm = case_when(arm == "arm1" ~ "ref",
                         TRUE ~ arm)) %>% 
  rename("Log10(TTP) Characteristics" = arm) %>% 
  kable(digits = 2) %>% 
  kable_styling() %>% 
  add_header_above(c("80 per regimen" = 1, "P(Continues based off of log10(TTP))" = 4)) %>% 
  group_rows(group_label = "Slopes are evenly distributed", start_row = 1, end_row = 5) %>% 
  group_rows(group_label = "Slopes are clustered high", start_row = 6, end_row = 10) %>% 
  group_rows(group_label = "Slopes are clustered high and low", start_row = 11, end_row = 15)
```

##### Figures

```{r barplot-ttp-results, fig.width = 6, fig.height= 5}
bind_rows(mutate(simlevel_ttp30$highlow_ttp, nk = 30),
          mutate(simlevel_ttp40$highlow_ttp, nk = 40),
          mutate(simlevel_ttp60$highlow_ttp, nk = 60),
          mutate(simlevel_ttp80$highlow_ttp, nk = 80)) %>% 
  filter(arm == "arm2" | arm == "arm3") %>% 
  group_by(nk, arm) %>% 
  summarise(`P(confidence < 0.8)` = mean(1 - continues.1criteria.80),
            `P(confidence < 0.9)` = mean(1 - continues.1criteria.90),
            `P(confidence < 0.95)` = mean(1 - continues.1criteria.95)) %>% 
  pivot_longer(names_to = "comparison",
               values_to = "prob",
               cols = 3:5) %>% 
  mutate(nk = factor(nk)) %>% 
  ggplot(aes(x = arm, y = prob, fill = nk)) +
  geom_bar(stat = "identity",
           position = position_dodge(width = 0.5),
           width = 0.45) + 
  facet_wrap(~comparison) + 
  theme_bw() + 
  scale_y_continuous("P(stopped for futility)") + 
  scale_x_discrete("TTP slope, relative to control",
                   labels = c("-10%", "10%")) + 
  scale_fill_manual(values = ucsf_col_pal)
```

```{r eval = FALSE}
ggsave(filename = here("graphs", "simulation-results", 
                       paste0(Sys.Date(), "_barplot-ttp-results.png")),
       device = "png",
       width = 5, 
       height = 5,
       units = "in")
```


#### Relapse Only {.tabset}

##### Sub-optimal regimen

```{r}
# Situation 1, S(52) = .95
load(here("data","analyzed","2022-03-07_s95-situation1-results_nk30_4mo-duration.RData"))
s95.sit1.30 <- s95.situation1.results
load(here("data","analyzed","2022-03-07_s95-situation1-results_nk40_4mo-duration.RData"))
s95.sit1.40 <- s95.situation1.results
load(here("data","analyzed","2022-03-07_s95-situation1-results_nk60_4mo-duration.RData"))
s95.sit1.60 <- s95.situation1.results
load(here("data","analyzed","2022-03-07_s95-situation1-results_nk80_4mo-duration.RData"))
s95.sit1.80 <- s95.situation1.results
```

```{r lineplot_relapses-sub-optimal}
library(latex2exp)
bind_rows(mutate(s95.sit1.30, nk = 30),
          mutate(s95.sit1.40, nk = 40),
          mutate(s95.sit1.60, nk = 60),
          mutate(s95.sit1.80, nk = 80)) %>% 
  group_by(nk, regimen) %>% 
  summarise(`At least 1` = mean(n_relapse_interim1 >= 1),
            `At least 2` = mean(n_relapse_interim1 >= 2),
            `At least 3` = mean(n_relapse_interim1 >= 3)) %>% 
  filter(regimen == 2) %>% # pull out sub-optimal regimen
  pivot_longer(cols = 3:5,
               names_to = "Observed relapses",
               values_to = "prob") %>% 
  ggplot(aes(x = nk, y = prob, col = `Observed relapses`)) + 
  geom_line(lwd = 1) + 
  theme_bw() + 
  scale_color_manual(values = ucsf_col_pal) + 
  xlab(TeX("Sample size per regimen, $n_k")) + 
  scale_y_continuous("P(stopped for futility)",
                     breaks = seq(0,1,by = 0.1),
                     labels = seq(0,1,by = 0.1)) + 
  ggtitle("Interim 1 Analysis of Futility - Relapse", 
          subtitle = "Sub-optimal regimen (relapse rate = 10%). Control relapse rate is 5%.")
```

```{r eval = FALSE}
ggsave(filename = here("graphs", "simulation-results",
                       paste0(Sys.Date(), "_lineplot_relapses-sub-optimal.png")),
       device = "png",
       width = 6,
       height = 5,
       units = "in")
```

##### Minimal regimen

```{r lineplot_relapses-minimal}
library(latex2exp)
bind_rows(mutate(s95.sit1.30, nk = 30),
          mutate(s95.sit1.40, nk = 40),
          mutate(s95.sit1.60, nk = 60),
          mutate(s95.sit1.80, nk = 80)) %>% 
  group_by(nk, regimen) %>% 
  summarise(`At least 1` = mean(n_relapse_interim1 >= 1),
            `At least 2` = mean(n_relapse_interim1 >= 2),
            `At least 3` = mean(n_relapse_interim1 >= 3)) %>% 
  filter(regimen == 3) %>% # pull out minimal regimen
  pivot_longer(cols = 3:5,
               names_to = "Observed relapses",
               values_to = "prob") %>% 
  ggplot(aes(x = nk, y = prob, col = `Observed relapses`)) + 
  geom_line(lwd = 1) + 
  theme_bw() + 
  scale_color_manual(values = ucsf_col_pal) + 
  xlab(TeX("Sample size per regimen, $n_k")) + 
  coord_cartesian(ylim = c(0,1)) +
  scale_y_continuous("P(stopped for futility)",
                     breaks = seq(0,1,by = 0.1),
                     labels = seq(0,1,by = 0.1)) + 
  ggtitle("Interim 1 Analysis of Futility - Relapse", 
          subtitle = "Minimal regimen (relapse rate = 5%). Control relapse rate is 5%.")
```

```{r eval = FALSE}
ggsave(filename = here("graphs", "simulation-results",
                       paste0(Sys.Date(), "_lineplot_relapses-minimal.png")),
       device = "png",
       width = 6,
       height = 5,
       units = "in")
```


##### Desirable regimen

```{r lineplot_relapses-desirable}
library(latex2exp)
bind_rows(mutate(s95.sit1.30, nk = 30),
          mutate(s95.sit1.40, nk = 40),
          mutate(s95.sit1.60, nk = 60),
          mutate(s95.sit1.80, nk = 80)) %>% 
  group_by(nk, regimen) %>% 
  summarise(`At least 1` = mean(n_relapse_interim1 >= 1),
            `At least 2` = mean(n_relapse_interim1 >= 2),
            `At least 3` = mean(n_relapse_interim1 >= 3)) %>% 
  filter(regimen == 5) %>% # pull out desirable regimen
  pivot_longer(cols = 3:5,
               names_to = "Observed relapses",
               values_to = "prob") %>% 
  ggplot(aes(x = nk, y = prob, col = `Observed relapses`)) + 
  geom_line(lwd = 1) + 
  theme_bw() + 
  scale_color_manual(values = ucsf_col_pal) + 
  xlab(TeX("Sample size per regimen, $n_k")) + 
  scale_y_continuous("P(stopped for futility)",
                     breaks = seq(0,1,by = 0.1),
                     labels = seq(0,1,by = 0.1)) + 
  coord_cartesian(ylim = c(0,1)) +
  ggtitle("Interim 1 Analysis of Futility - Relapse", 
          subtitle = "Desirable regimen (relapse rate = 2.5%). Control relapse rate is 5%.")
```

```{r eval = FALSE}
ggsave(filename = here("graphs", "simulation-results",
                       paste0(Sys.Date(), "_lineplot_relapses-desirable.png")),
       device = "png",
       width = 6,
       height = 5,
       units = "in")
```


#### Log10(TTP) and Relapse

```{r}
simlevel_ttp30 <- bind_rows(mutate(simlevel_ttp30$even_ttp, ttp.condition = "even"),
                            mutate(simlevel_ttp30$high_ttp, ttp.condition = "high"),
                            mutate(simlevel_ttp30$highlow_ttp, ttp.condition = "highlow")) %>% 
  mutate(regimen = str_remove(arm, "arm"))

simlevel_ttp40 <- bind_rows(mutate(simlevel_ttp40$even_ttp, ttp.condition = "even"),
                            mutate(simlevel_ttp40$high_ttp, ttp.condition = "high"),
                            mutate(simlevel_ttp40$highlow_ttp, ttp.condition = "highlow")) %>% 
  mutate(regimen = str_remove(arm, "arm"))

simlevel_ttp60 <- bind_rows(mutate(simlevel_ttp60$even_ttp, ttp.condition = "even"),
                            mutate(simlevel_ttp60$high_ttp, ttp.condition = "high"),
                            mutate(simlevel_ttp60$highlow_ttp, ttp.condition = "highlow")) %>% 
  mutate(regimen = str_remove(arm, "arm"))

simlevel_ttp80 <- bind_rows(mutate(simlevel_ttp80$even_ttp, ttp.condition = "even"),
                            mutate(simlevel_ttp80$high_ttp, ttp.condition = "high"),
                            mutate(simlevel_ttp80$highlow_ttp, ttp.condition = "highlow")) %>% 
  mutate(regimen = str_remove(arm, "arm"))
```

```{r}
# Situation 1
df_30 <- full_join(simlevel_ttp30, 
                   s95.sit1.30) %>% 
  mutate(nk = 30)
df_40 <- full_join(simlevel_ttp40, 
                   s95.sit1.40) %>% 
  mutate(nk = 40)
df_60 <- full_join(simlevel_ttp60, 
                   s95.sit1.60) %>% 
  mutate(nk = 60)
df_80 <- full_join(simlevel_ttp80, 
                   s95.sit1.80) %>% 
  mutate(nk = 80)

bind_rows(df_30,
          df_40,
          df_60,
          df_80) %>% 
  group_by(ttp.condition, regimen, nk) %>% 
  summarise(`P(confidence < 0.8, >= 1 relapse)` = mean(continues.1criteria.80 == 0 & n_relapse_interim1 >= 1, na.rm = TRUE),
            `P(confidence < 0.8, >= 2 relapse)` = mean(continues.1criteria.80 == 0 & n_relapse_interim1 >= 2, na.rm = TRUE),
            `P(confidence < 0.8, >= 3 relapse)` = mean(continues.1criteria.80 == 0 & n_relapse_interim1 >= 3, na.rm = TRUE)) %>% 
  mutate("TTP Slope" = case_when(regimen == 1 ~ "ref",
                                 (ttp.condition == "even" & regimen == 2) | (ttp.condition == "highlow" & regimen == 3) ~ "10%",
                                 ttp.condition == "even" & regimen == 3 ~ "20%",
                                 ttp.condition == "even" & regimen == 4 ~ "30%",
                                 (ttp.condition == "even" & regimen == 5) | 
                                   (ttp.condition == "highlow" & regimen == 5) ~ "40%",
                                 ttp.condition == "highlow" & regimen == 2 ~ "-10%",
                                 (ttp.condition == "highlow" & regimen == 4) | 
                                   (ttp.condition == "high" & regimen == 2) ~ "35%",
                                 ttp.condition == "high" & regimen == 3 ~ "37%",
                                 ttp.condition == "high" & regimen == 4 ~ "39%",
                                 ttp.condition == "high" & regimen == 5 ~ "41%"),
         .before = 1) %>%
  mutate("Relapse rate" = case_when(regimen == 1 ~ "5%",
                                    regimen == 2 ~ "10%",
                                    regimen %in% c(3,4) ~ "5%",
                                    regimen == 5 ~ "2.5%"),
         .before = 2) %>% 
  mutate(Regimen = ifelse(regimen == 1, "Control", paste0("Regimen ", regimen)),
         .before = 3) %>% 
  ungroup() %>% 
  dplyr::select(-ttp.condition, -regimen, -`TTP Slope`, -`Relapse rate`, - Regimen) %>% 
  kable(digits = 2) %>% 
  kable_styling() %>% 
  collapse_rows(columns = 1:3) %>% 
  group_rows(group_label = "Even (TTP). Mixed relapse rates.",
             start_row = 1,
             end_row = 20,
             label_row_css = "background-color: #066; color:#fff;") %>% 
  group_rows(group_label = "Control (relapse rate = 5%)",
           start_row = 1,
           end_row = 4) %>% 
  group_rows(group_label = "Regimen 1: suboptimal (TTP slope = 10%, relapse rate = 10%)",
           start_row = 5,
           end_row = 8) %>% 
  group_rows(group_label = "Regimen 2: minimal (TTP slope = 20%, relapse rate = 5%)",
           start_row = 9,
           end_row = 12) %>%
  group_rows(group_label = "Regimen 3: minimal (TTP slope = 30%, relapse rate = 5%)",
           start_row = 13,
           end_row = 16) %>% 
  group_rows(group_label = "Regimen 4: desirable (TTP slope = 40%, relapse rate = 2.5%)",
           start_row = 17,
           end_row = 20) %>% 
  group_rows(group_label = "High (TTP). Mixed relapse rates.",
             start_row = 21,
             end_row = 40,
             label_row_css = "background-color: #066; color:#fff;") %>% 
  group_rows(group_label = "Control (relapse rate = 5%)",
           start_row = 21,
           end_row = 24) %>% 
  group_rows(group_label = "Regimen 1: suboptimal (TTP slope = 35%, relapse rate = 10%)",
           start_row = 25,
           end_row = 28) %>% 
  group_rows(group_label = "Regimen 2: minimal (TTP slope = 37%, relapse rate = 5%)",
           start_row = 29,
           end_row = 32) %>%
  group_rows(group_label = "Regimen 3: minimal (TTP slope = 39%, relapse rate = 5%)",
           start_row = 33,
           end_row = 36) %>% 
  group_rows(group_label = "Regimen 4: desirable (TTP slope = 41%, relapse rate = 2.5%)",
           start_row = 37,
           end_row = 40) %>% 
  group_rows(group_label = "High-low (TTP)",
             start_row = 41,
             end_row = 60,
             label_row_css = "background-color: #066; color:#fff;") %>% 
  group_rows(group_label = "Control (relapse rate = 5%)",
           start_row = 41,
           end_row = 44) %>% 
  group_rows(group_label = "Regimen 1: suboptimal (TTP slope = -10%, relapse rate = 10%)",
           start_row = 45,
           end_row = 48) %>% 
  group_rows(group_label = "Regimen 2: minimal (TTP slope = 10%, relapse rate = 5%)",
           start_row = 49,
           end_row = 52) %>%
  group_rows(group_label = "Regimen 3: minimal (TTP slope = 35%, relapse rate = 5%)",
           start_row = 53,
           end_row = 56) %>% 
  group_rows(group_label = "Regimen 4: desirable (TTP slope = 40%, relapse rate = 2.5%)",
           start_row = 57,
           end_row = 60) 
```

<!-- ```{r sim-study-relapse-table, cache=TRUE} -->
<!-- sit.names <- unique(df_relapses_even$setting) -->
<!-- sit.names <- str_replace(str_replace(str_replace(sit.names, pattern = "situation1", " Mixed."), -->
<!--                          "situation2", " All desirable."), -->
<!--                          "situation3", " All minimal.") -->
<!-- sit.names <- data.frame(setting = unique(df_relapses_even$setting), -->
<!--                         Setting = str_replace(sit.names, "s9", "S1(26) = 0.9")) -->

<!-- bind_rows(df_relapses$df_relapses_even, -->
<!--           df_relapses$df_relapses_high, -->
<!--           df_relapses$df_relapses_highlow) %>%  -->
<!--   group_by(regimen, duration, setting) %>%  -->
<!--   summarise(relapse.1 = 100*(sum(n_relapses == 1)/3000), -->
<!--             relapse.2 = 100*(sum(n_relapses == 2)/3000), -->
<!--             relapse.3.or.more = 100*(sum(n_relapses >= 3)/3000), -->
<!--             nsims = 3000) %>%  -->
<!--   left_join(sit.names) %>%  -->
<!--   filter(Setting == "S1(26) = 0.97. Mixed." | is.na(setting)) %>%  -->
<!--   rename(Regimen = regimen, -->
<!--          Duration = duration, -->
<!--          Characteristic = setting, -->
<!--          `Perc. sims with 1 relapse` = relapse.1, -->
<!--          `Perc. sims with 2 relapses` = relapse.2, -->
<!--          `Perc. sims with 3+ relapses` = relapse.3.or.more, -->
<!--          `No. sims` = nsims) %>%  -->
<!--   dplyr::select(-Characteristic, -Setting) %>%  -->
<!--   arrange(Regimen) %>%  -->
<!--   kable(caption = "S(26) = 0.97 for HRZE. Mixed characteristics.", -->
<!--         digits = 2) %>%  -->
<!--   kable_styling() %>%  -->
<!--   collapse_rows(columns = 1) -->

<!-- bind_rows(df_relapses$df_relapses_even, -->
<!--           df_relapses$df_relapses_high, -->
<!--           df_relapses$df_relapses_highlow) %>%  -->
<!--   group_by(setting) %>%  -->
<!--   arrange(regimen, simulation) %>%  -->
<!--   mutate(rown = row_number()) %>%  -->
<!--   # Pulling only 1 entry from the control group -->
<!--   filter((rown == 1 & regimen == 1) | regimen != 1) %>%  -->
<!--   filter(simulation == 1) %>%  -->
<!--   mutate(regimen = factor(regimen), -->
<!--          duration = factor(duration)) %>%  -->
<!--   group_by(regimen, duration, setting) %>%  -->
<!--   summarise(relapse.1 = 100*(sum(n_relapses == 1)/3000), -->
<!--             relapse.2 = 100*(sum(n_relapses == 2)/3000), -->
<!--             relapse.3.or.more = 100*(sum(n_relapses >= 3)/3000)) %>%  -->
<!--   left_join(sit.names) %>%  arrange(regimen) %>%   -->
<!--   filter(Setting == "S1(26) = 0.97. All desirable." | is.na(setting)) %>%  -->
<!--   rename(Regimen = regimen, -->
<!--          Duration = duration, -->
<!--          Characteristic = setting, -->
<!--          `Perc. sims with 1 relapse` = relapse.1, -->
<!--          `Perc. sims with 2 relapses` = relapse.2, -->
<!--          `Perc. sims with 3+ relapses` = relapse.3.or.more) %>%  -->
<!--   dplyr::select(-Characteristic, -Setting) %>%  -->
<!--   arrange(Regimen) %>%  -->
<!--   kable(caption = "S(26) = 0.97 for HRZE. All desirable.", -->
<!--         digits = 2) %>%  -->
<!--   kable_styling() -->

<!-- bind_rows(df_relapses$df_relapses_even, -->
<!--           df_relapses$df_relapses_high, -->
<!--           df_relapses$df_relapses_highlow) %>%  -->
<!--   mutate(rown = row_number()) %>%  -->
<!--   filter((rown == 1 & regimen == 1) | regimen != 1) %>%  -->
<!--   group_by(regimen, duration, setting) %>%  -->
<!--   summarise(relapse.1 = 100*(sum(n_relapses == 1)/3000), -->
<!--             relapse.2 = 100*(sum(n_relapses == 2)/3000), -->
<!--             relapse.3.or.more = 100*(sum(n_relapses >= 3)/3000)) %>%  -->
<!--   left_join(sit.names) %>%  -->
<!--   filter(Setting == "S1(26) = 0.97. All minimal." | is.na(setting)) %>%  -->
<!--   rename(Regimen = regimen, -->
<!--          Duration = duration, -->
<!--          Characteristic = setting, -->
<!--          `Perc. sims with 1 relapse` = relapse.1, -->
<!--          `Perc. sims with 2 relapses` = relapse.2, -->
<!--          `Perc. sims with 3+ relapses` = relapse.3.or.more) %>%  -->
<!--   dplyr::select(-Characteristic, -Setting) %>%  -->
<!--   arrange(Regimen) %>%  -->
<!--   kable(caption = "S(26) = 0.97 for HRZE. All minimal", -->
<!--         digits = 2) %>%  -->
<!--   kable_styling() -->
<!-- ``` -->

<!-- 1. Drop any regimen with less than 80% confidence that it has a larger effect size on log10(TTP) slope than the control regimen.  -->

<!-- 2. Drop any regimen with less than 80% confidence that it is in the top 2 best regimens. -->


<!-- ```{r} -->
<!-- ``` -->

<!-- ### Analysis of a single single simulated dataset {.tabset .tabset-pills} -->

<!-- ```{r single-dataset, cache = TRUE} -->
<!-- load(here("data","simulated-datasets","2022-02-24_full-data-nk30-survival-97.RData")) -->
<!-- df_single <- nk_30_outcome_1$nk_30_even[[1]]$s97.situation1 -->
<!-- rm(nk_30_outcome_1) -->
<!-- ``` -->

<!-- **Conclusion.** (Note: these are not full results as duration was not properly randomized) -->

<!-- Based on the log10(TTP) results, we can say with 87.6% confidence that regimen 5 is the best. Our most credible estimate of its corresponding improvement in slope relative to HRZE is 34% (95% CI: 15.2%, 54.4%). -->

<!-- With respect to the relapse data, we would drop regimens 2 and 4. -->

<!-- Rule:  -->
<!-- > Relapses – stop any 2m arms with > 3 / 10 relapses; stop any 3m arms with > 2 relapses if the 2m arm has stopped, stop whole regimen if have stopped 2m, 3m arms and have > 2 relapses in the 4m arm; or if have > 4 relapses in the 4m arm alone. -->


<!-- #### Visualization  -->

<!-- ```{r interim-visualization, fig.width = 10, fig.height = 8, fig.cap= "This (or similar) visualization could be generated at the interim point to be able to examine the data for obvious patterns."} -->
<!-- # date of interim analysis -->
<!-- interim_date <- df_single %>%  -->
<!--   filter((week + enroll.day/7) == max(week + enroll.day/7)) %>%  -->
<!--   mutate(interim.week = (week + # date of last visit -->
<!--                          enroll.day/7 + #date of enrollment -->
<!--                          4)) # 25 days for culture conversion -->

<!-- df_single <- df_single %>%  -->
<!--   mutate(observed.relapse = ifelse(status == 1 & eventtime <= 52 - duration, 1, 0), -->
<!--               observed.relapse.date.trial = ifelse(observed.relapse == 1, eventtime + duration + enroll.day/7, NA)) %>%  -->
<!--   mutate(relapse.interim1 = ifelse(observed.relapse == 1 & observed.relapse.date.trial <= interim_date$interim.week, 1,  -->
<!--                                                           ifelse(observed.relapse == 0, 0, 0))) %>%  -->
<!--   mutate(Regimen = paste0("Regimen ", regimen), -->
<!--          Duration = factor(duration, levels = c(8,10,12,14,16,26)))  -->

<!-- df_single %>% -->
<!--   ggplot(aes(x = enroll.day/7 + patient.visit.week, y = reorder(patient.id, enroll.day), col = Regimen)) +  -->
<!--   facet_wrap(~Regimen, scales = "free") + -->
<!--   geom_segment(aes(yend = patient.id, x = enroll.day/7 + duration, -->
<!--                    xend = 52 + enroll.day/7), -->
<!--                col = "darkgray", alpha = 0.4, -->
<!--                lty = 1) + -->
<!--   geom_segment(aes(yend = patient.id, x = enroll.day/7, -->
<!--                    xend = enroll.day/7 + duration, -->
<!--                    lty = Duration)) + -->
<!--   geom_vline(xintercept = interim_date$interim.week, -->
<!--              lty = 2, -->
<!--              col = "black") + -->
<!--   annotate("text", x = interim_date$interim.week + 6, y = 1.5, label = "Interim 1", col = "black", -->
<!--            hjust = 0) + -->
<!--   coord_cartesian(xlim = c(0,100)) + -->
<!--   scale_y_discrete("Patient enrolment") + -->
<!--   scale_x_continuous("Trial time (weeks)") + -->
<!--   geom_point(aes(x = observed.relapse.date.trial), -->
<!--              pch = 4, -->
<!--              col = "black") + -->
<!--   ggpubr::theme_pubr() + -->
<!--   theme(axis.ticks.y = element_blank(), -->
<!--         axis.text.y = element_blank(), -->
<!--         legend.position = "right", -->
<!--         legend.direction = "vertical") -->
<!-- ``` -->

<!-- #### Tables  -->

<!-- ```{r relapse-count} -->
<!-- relapses <- df_single %>%  -->
<!--   group_by(regimen, duration, relapses_observed = (!is.na(observed.relapse.date.trial) & observed.relapse.date.trial <= interim_date$interim.week)) %>%  -->
<!--   summarise(n_relapses = n_distinct(patient.id)) %>% # for now - participants are generating more than 1 relapse. MUST FIX -->
<!--   filter(relapses_observed == TRUE) %>%  -->
<!--   dplyr::select(-relapses_observed) -->
<!-- ``` -->

<!-- ```{r log10ttp-data-eval} -->

<!-- mcmc_output <- mcmc_m1 -->

<!-- true.change.slope <- data.frame(regimen = factor(1:5), true.change = c("ref", 0.1, 0.2, 0.3, 0.4)) -->
<!-- pairwise_comparisons_ref <- pairwise_function(mcmc_output) %>%  -->
<!--   mutate(regimen = rep(factor(2:5), 2)) -->

<!-- # pairwise_confidence_ref <-  -->

<!-- confidence_best <- map_dfr(as.list(paste0("arm", 1:5)), -->
<!--                        ~best_v_rest_function(mcmc_output, bestarm = .x), -->
<!--                        .id = "regimen") -->

<!-- best_in_subset_2 <- map_dfr(as.list(paste0("arm", 1:5)), ~best_in_subset_function(mcmc_output, -->
<!--                                                         subset.size = 2, -->
<!--                                                         true.best = .x), -->
<!--                             .id = "regimen") %>%  -->
<!--   mutate(regimen = factor(1:5))  %>%  -->
<!--   rename(perc.confidence.2 = perc.confidence) %>%  -->
<!--   dplyr::select(-subset.size) -->

<!-- best_in_subset_3 <- map_dfr(as.list(paste0("arm", 1:5)), ~best_in_subset_function(mcmc_output, -->
<!--                                                         subset.size = 3, -->
<!--                                                         true.best = .x), -->
<!--                             .id = "regimen") %>%  -->
<!--   mutate(regimen = factor(1:5)) %>%  -->
<!--   rename(perc.confidence.3 = perc.confidence) %>%  -->
<!--   dplyr::select(-subset.size) -->

<!-- ``` -->

<!-- ```{r single-data-table} -->
<!-- full_table <- full_join( -->
<!--   full_join( -->
<!--     full_join( -->
<!--       full_join( -->
<!--         full_join(relapses,  -->
<!--                   true.change.slope), -->
<!--         pairwise_comparisons_ref), -->
<!--       confidence_best), -->
<!--     best_in_subset_2), -->
<!--   best_in_subset_3) -->


<!-- full_table %>%  -->
<!--   filter(vals == "relative slopes" | regimen == 1) %>%  -->
<!--   rename(Regimen = regimen, -->
<!--          Duration = duration,  -->
<!--          `No. relapses` = n_relapses, -->
<!--          `True percent change in slope` = true.change, -->
<!--          `Est. percent change in slope` = median, -->
<!--          CI.l = CI.l, -->
<!--          CI.u = CI.u, -->
<!--          `P(regimen is best)` = prop_best, -->
<!--          `P(regimen is one of top 2 best)` = perc.confidence.2, -->
<!--          `P(regimen is one of top 3 best)` = perc.confidence.3) %>%  -->
<!--   dplyr::select(-contrast, -vals) %>%  -->
<!--   kable(digits = 3, -->
<!--         caption = "This (or similar) table could provide a dashboard of useful information for decision-making.") %>%  -->
<!--   kable_styling() -->
<!-- ``` -->


